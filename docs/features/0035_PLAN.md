Title: Refactor ui/src/lib/serverComm.ts into modular API client

Context
- The current `ui/src/lib/serverComm.ts` is a single, 1,200+ line module that centralizes API base URL resolution, auth token handling, error handling, types, and dozens of endpoint helpers across many domains (Events, Event Templates, Event Series, Schedules/Shifts/Assignments, Departments/Employees/Positions/EmployeePositions, Areas, Inventory, Contacts, and various Bootstrap endpoints). It exports both named helpers (e.g., `listEvents`, `createEvent`, `updateEvent`, etc.) and an aggregated `api` object populated post-declaration.
- This file has “gotten way out of hand” and needs a careful refactor into smaller, typed, testable modules with a compatibility layer for incremental migration.
- Existing consumers import from `@/lib/serverComm` broadly, including uses of `api.*` with optional chaining.

Goals
- Maintain backward compatibility during migration (old imports continue to work).
- Extract a shared HTTP client (base URL, auth token, error handling) and per-domain modules.
- Preserve all existing endpoint signatures and behaviors initially; improve consistency and typings.
- Add thorough, automated tests first for the new client and modules.
- Enable incremental consumer migration and eventual removal of the legacy file.

Key Consumers (verbatim import usage to be supported during migration)
- Pages/components call named exports and `api` aggregator from `@/lib/serverComm`, e.g.:
  - `ui/src/pages/Schedules.tsx` imports `{ api, type ScheduleRecord, type ShiftRecord, type DepartmentRecord }` and uses `api.listSchedules?.()`, `api.listDepartments?.()`, `api.createSchedule?.(...)`, etc.
  - `ui/src/pages/Scheduling.tsx` imports `{ api, DepartmentRecord, ScheduleRecord, ShiftRecord, PositionRecord, EligibleEmployee, Area, EmployeeRecord }` and uses many `api.*` methods via optional chaining.
  - Numerous files import named helpers like `listEventTemplates`, `listEventSeries`, `bootstrapEvents`, `getEventAreas`, etc., from `@/lib/serverComm`.
  - `ui/src/components/connection-status.tsx` imports `API_BASE_URL` from `@/lib/serverComm`.
  - Some dynamic imports exist (e.g., `EventAreasPanel` calls `import('@/lib/serverComm')` to call `removeEventArea`).

Testing Strategy (define before implementing)
- Add unit tests for the HTTP client and each domain module using Vitest and MSW.
- Test matrix (non-exhaustive but mandatory):
  - Base URL resolution
    - Uses `VITE_API_URL` if provided; trims trailing slash; auto-prepends scheme if missing (defaults to https); default fallback remains `http://localhost:8787`.
  - Auth header
    - When Firebase user present → `Authorization: Bearer <token>` set.
    - When no user → Authorization omitted; in DEV, warning logs remain (no throw solely due to missing auth).
  - Error handling
    - Non-2xx responses throw `APIError(status, message)`; message includes `statusText` and optional `error` field from JSON body when present.
    - DELETE 204 with no body is treated as success and does not attempt to parse JSON.
  - Query serialization
    - Booleans converted to `true|false` strings; arrays serialised as comma-separated strings where current code does so (e.g., `areaId` and `eventType`).
  - Endpoint coverage
    - For each domain module, tests verify URL path, HTTP method, headers, query/body shape, and response parsing for at least 1-2 representative endpoints.
  - Edge cases
    - JSON parse fallback when response body is not JSON; ensure thrown error includes status.
    - Dynamic import scenarios still function via the compatibility barrel.

Dependencies to add (dev)
- `vitest`, `@vitest/ui`, `msw`, `whatwg-fetch` (or cross-fetch) for tests; install via `pnpm add -D`.

Planned File/Module Structure
- `ui/src/lib/api/client.ts`
  - Expose `resolveApiBaseUrl()`, `API_BASE_URL`, `fetchWithAuth()`, and `APIError`.
  - Export token retrieval helper wired to Firebase (`getAuthToken()`), preserving current behavior.
- `ui/src/lib/api/errors.ts`
  - Define `APIError` type/class (if not left in `client.ts`).
- `ui/src/lib/api/utils.ts`
  - Common URL/query helpers; query param formatting helpers.
- `ui/src/lib/api/types.ts`
  - Shared domain types rehomed from legacy (e.g., `EventRecord`, `Area`, `DepartmentRecord`, etc.). Keep names stable.
- Domain modules (one file per domain):
  - `ui/src/lib/api/events.ts` (events, shifts-for-event, areas-for-event, bootstrap event(s))
  - `ui/src/lib/api/eventTemplates.ts` (templates, versions, requirements, apply-to-event)
  - `ui/src/lib/api/eventSeries.ts`
  - `ui/src/lib/api/schedules.ts` (schedules, publish/unpublish)
  - `ui/src/lib/api/shifts.ts`
  - `ui/src/lib/api/assignments.ts`
  - `ui/src/lib/api/departments.ts`
  - `ui/src/lib/api/employees.ts`
  - `ui/src/lib/api/positions.ts`
  - `ui/src/lib/api/employeePositions.ts`
  - `ui/src/lib/api/areas.ts`
  - `ui/src/lib/api/inventory.ts`
  - `ui/src/lib/api/contacts.ts`
- `ui/src/lib/api/index.ts`
  - Barrel re-exports per-domain named functions and types.
  - Also exports a generated `api` aggregator to mimic legacy usage during migration.
- Compatibility layer
  - Replace `ui/src/lib/serverComm.ts` contents with a thin barrel that re-exports from `ui/src/lib/api/*`, including `API_BASE_URL`, named helpers, and the `api` aggregator. Mark as deprecated in comments.

Scope of Endpoints (mapping legacy → new modules)
- Events: `listEvents`, `createEvent`, `getEvent`, `updateEvent`, `deleteEvent`, `listShiftsForEvent`, `listEventShifts`, `bootstrapEvents`, `bootstrapEventDetail`, `getAreasForEvents`, `getEventAreas`, `replaceEventAreas`, `addEventArea`, `removeEventArea`.
- Event Templates: `listEventTemplates`, `createEventTemplate`, `getEventTemplate`, `updateEventTemplate`, `listTemplateVersions`, `createTemplateVersion`, `activateTemplateVersion`, `getTemplateRequirements`, `putTemplateRequirements`, `applyTemplateToEvent`.
- Event Series: `listEventSeries`, `createEventSeries`, `getEventSeries`, `updateEventSeries`, `deleteEventSeries`, `getEventSeriesAreas`, `putEventSeriesAreas`, `addEventSeriesArea`, `removeEventSeriesArea`, `previewEventSeries`, `generateEventSeries`, `getEventSeriesRule`, `updateEventSeriesRule`.
- Schedules: `listSchedules`, `createSchedule`, `getSchedule`, `updateSchedule`, `publishSchedule`, `unpublishSchedule`, `deleteSchedule`.
- Shifts: `listShifts`, `listAllShifts`, `generateShiftsForSchedule`, `createShift`, `getShift`, `updateShift`, `deleteShift`.
- Assignments: `listAssignments`, `createAssignment`, `updateAssignment`, `deleteAssignment`.
- Departments/Employees/Positions/EmployeePositions: existing helpers as defined in legacy `serverComm.ts`.
- Inventory: items, transactions, items summary, reservations, locations, schemas.
- Areas: list/create/update/delete/reorder.
- Contacts: list/create/get/update/delete.

Algorithms and Behaviors to Preserve/Normalize
1) Base URL resolution
   - Keep current logic: environment var `VITE_API_URL` → normalize scheme (prepend https if missing), strip trailing slash, fallback to `http://localhost:8787`.
2) Auth token
   - Use Firebase `getAuth`/`onAuthStateChanged`; wait briefly for initialization (same timeout semantics) before deciding to omit Authorization.
3) Error handling
   - On non-OK response, attempt to parse JSON; when `error` string present include in message; throw `APIError(status, message)`.
4) 204 handling
   - Do not parse JSON for 204 DELETE endpoints.
5) Query serialization
   - Continue current conventions: booleans as `true|false`; join arrays by comma for endpoints that expect them.
6) Dynamic import compatibility
   - Maintain a default export point `@/lib/serverComm` that continues to re-export the same named helpers and `api` object.

Phases
Phase 0 — Inventory & Test Harness
- Confirm the list of all consumers of `@/lib/serverComm` (already sampled: `Schedules.tsx`, `Scheduling.tsx`, `Events.tsx`, `EventsCalendar.tsx`, `Templates.tsx`, `Areas.tsx`, `Contacts.tsx`, `Inventory*.tsx`, `features/*`, `components/connection-status.tsx`).
- Add Vitest and MSW setup to `ui` workspace:
  - `pnpm -C ui add -D vitest @vitest/ui msw whatwg-fetch`
  - Add `ui/vitest.config.ts`, `ui/src/test/setup.ts` to register MSW and fetch polyfill.

Phase 1 — Core HTTP Client and Types (no consumer changes)
- Create `ui/src/lib/api/client.ts` exposing `resolveApiBaseUrl`, `API_BASE_URL`, `APIError`, `getAuthToken`, and `fetchWithAuth`.
- Create `ui/src/lib/api/types.ts` and move all shared types from legacy file.
- Tests: `ui/src/lib/api/__tests__/client.test.ts` covering base URL, auth header attach/omit, error throw, 204 handling.

Phase 2 — Domain Modules (preserve signatures)
- Create per-domain files under `ui/src/lib/api/` and move matching functions with unchanged names and signatures.
- Tests: for each domain, add a `__tests__` file that validates method/URL/headers/body/response parsing for representative endpoints.

Phase 3 — Barrel and Compatibility
- Create `ui/src/lib/api/index.ts` re-exporting all named functions/types. Export `api` aggregator containing the same members currently assigned on legacy `api` object (to keep compatibility for `api.*` users).
- Replace `ui/src/lib/serverComm.ts` contents with a thin barrel that re-exports from `ui/src/lib/api/*` and also re-exports `api`. Keep `API_BASE_URL` export. Add a `console.warn` in DEV for deprecated module usage (once per session).
- No consumer change yet; green tests ensure parity.

Phase 4 — Incremental Consumer Migration
- Update imports in high-churn/owner modules first to import from the new barrels, e.g.:
  - `Schedules.tsx`, `Scheduling.tsx` → switch to `@/lib/api` (keep using `api` initially) or progressively replace `api.*` calls with direct named imports.
  - Feature pages can import domain-specific helpers, e.g., `@/lib/api/eventTemplates`, `@/lib/api/eventSeries`.
- Ensure dynamic import sites still work; if any bundle-splitting is desired, expose stable entry points for those.
- Run UI build and tests after each batch.

Phase 5 — Cleanup and Hardening
- Once all imports move off `@/lib/serverComm`, remove the deprecated file and update all references (including any dynamic imports).
- Optionally introduce lint rule to block new imports from `@/lib/serverComm`.
- Add stricter TypeScript response types where feasible.

Phase 6 — Optional Enhancements (post-refactor)
- Add request cancellation/AbortController utilities and optional timeouts.
- Add transparent response schema validation (e.g., zod) in dev.
- Consider React Query integration for caching/retries; out of scope for the initial refactor.

Acceptance Criteria
- All existing screens compile and work without behavior changes under the compatibility layer.
- Unit tests for client and each domain module pass; CI green for `ui` workspace.
- `serverComm.ts` reduced to a thin re-export (Phase 3) and later removed (Phase 5) once all consumers migrate.
- Bundle size improves due to tree-shaking of domain modules.

Risk Mitigations
- Keep signatures identical; preserve `api` aggregator for `?.` call sites.
- Stage migrations by feature to minimize blast radius.
- Strong tests for HTTP client and representative endpoints to catch regressions early.

Notes/Constraints
- Tech stack constraints: React (vite), Tailwind, ShadCN, Firebase Auth, Supabase Postgres, pnpm, Node.JS, Hono API.
- Use `pnpm add` for dependencies; `npx shadcn add` for components if any UI scaffolding is added (not anticipated here).
- Env: continue using `VITE_API_URL`; call out any new envs explicitly (none planned).


