### 0016 — Production Inventory UI — Implementation Plan (post-0015)

Brief context:
- Backend additions from `@0015_PLAN.md` are implemented: transactions listing endpoint, item summary with window-aware availability, unit conversion, policy enforcement, valuation updates, and `department_id` filter for locations. Client helpers in `serverComm` are extended accordingly.

---

### Scope

- Deliver a Production-focused UI under `/inventory` leveraging the new server capabilities: list, detail, activity, reservations, and asset workflows (checkout/checkin, transfer, count adjust, maintenance start/end).
- Use the following implemented endpoints/helpers:
  - `GET /api/v1/inventory/transactions` via `serverComm.listInventoryTransactions`.
  - `GET /api/v1/inventory/items/:itemId/summary` via `serverComm.getInventoryItemSummary`.
  - `GET /api/v1/inventory/locations` with optional `department_id` via `serverComm.listInventoryLocations({ departmentId })`.
  - Existing `POST /api/v1/inventory/transactions` (now supports `{ qty, unit }` or `{ qtyBase }`), reservations, and items endpoints.
- Add venue-optimized workflows: scan-first operations, event-centric quick actions, kit/preset issuance, shortage visibility, and end-of-night reconciliation.
- No new backend work is required for these UI features; handle policy/validation errors from the server cleanly.

---

### UI Routes and Navigation

- Add Production routes under `/inventory`:
  - `/inventory/production` — Production dashboard (summary KPIs + quick actions)
  - `/inventory/production/items` — items list (Production filters)
  - `/inventory/production/items/:itemId` — item detail (overview, serials, activity, reservations, maintenance)
  - `/inventory/production/transactions/new` — transaction wizard (checkout/checkin/transfer/count adjust)
  - `/inventory/production/reconciliation` — end-of-night reconciliation (expected vs scanned)
  - `/inventory/production/events` — event quick-pick (if events service available; otherwise recent IDs/manual entry)
  - `/inventory/production/events/:eventId` — event console: checkout/return focused on one event

Files (UI):
- Update `ui/src/App.tsx` to add the routes above.
- Keep `ui/src/pages/Inventory.tsx` as the generic landing; link to Production page.
- New components under `ui/src/features/inventory/production/`:
  - `ProductionInventoryPage.tsx` — dashboard shell (KPI cards: On-hand, Available, Recent Activity)
  - `ProductionItemsTable.tsx` — searchable/filterable items table
  - `ProductionItemDetail.tsx` — item header + tabs
    - `OverviewTab.tsx` — on-hand by location, attributes summary
    - `SerialsTab.tsx` — serialized assets list (placeholder until serials API is ready; hide for non-serialized)
    - `ActivityTab.tsx` — transactions timeline for the item
    - `ReservationsTab.tsx` — list/create/release reservations
    - `MaintenanceTab.tsx` — start/end maintenance, log issue/repair notes
  - `CheckoutWizard.tsx` — checkout/checkin flow (supports serial or quantity)
  - `TransferDialog.tsx` — location-to-location transfer
  - `CountAdjustDialog.tsx` — cycle count adjust (computes delta)
  - `EventConsole.tsx` — issue/return to a selected event; duplicate previous lists, partial returns
  - `ReconciliationPage.tsx` — end-of-night compare expected vs scanned; propose adjustments
  - `ScanModeToggle.tsx` — global scan input focus + audible/visual feedback
  - `PresetPicker.tsx` — save/load common rigs (client-side presets using `sourceDoc`)
  - `ShortagePanel.tsx` — show overbook/understock warnings and alternative locations
  - `ConsumablesCard.tsx` — low-stock consumables/par thresholds quick view

Component notes:
- Use ShadCN primitives already in the project (tables, dialogs, tabs). Add components via `npx shadcn add` if needed.
- Keep state with local React state + async calls in `serverComm` (no new global state lib).
- Default to dark mode; optimize for keyboard usage and mobile responsiveness.
- Barcode/QR scanning: use focused text input that accepts scans as keystrokes; play success/error sounds and flash indicators.

---

### Backend/API Consumption (implemented in 0015)

- Transactions list (Activity):
  - Use `serverComm.listInventoryTransactions(params?: { itemId?: string; locationId?: string; eventType?: string | string[]; from?: string; to?: string; limit?: number; order?: 'asc'|'desc' })`.
  - Default `order='desc'`, `limit=100`; support “Load more” to paginate.

- Item on‑hand & availability summary (KPIs/Overview):
  - Use `serverComm.getInventoryItemSummary(itemId, { from?, to? })`.
  - Show totals `{ onHand, reserved, available }` and per‑location rows; allow a date range picker to drive `[from, to]`.

- Locations by department:
  - Use `serverComm.listInventoryLocations({ departmentId? })` to filter locations where needed in flows.

- Posting flows:
  - Use `serverComm.postInventoryTransaction` with either `{ qtyBase }` or `{ qty, unit }` (unit conversion handled server‑side).
  - Surface server policy rejections and valuation behaviors as messages in the UI.

- Event quick-pick:
  - If an events endpoint is available, present upcoming/recent events; otherwise allow manual `eventId` entry or selection from reservations.

- Shortage visibility and alternatives:
  - Use `getInventoryItemSummary` for current/windowed availability and `listInventoryLocations` to point to alternative locations when under stock.

---

### UX/Flows (Production)

1) Items list
   - Columns: SKU, Name, Type, Serialized?, On-hand (sum), Available (sum − reservations), Locations (count), Active.
   - Filters: `q`, `item_type` in {ReturnableAsset, FixedAsset, Rental, Kit, Consumable}, Active/Inactive.
   - Row actions: View, Checkout, Transfer, Count Adjust.
   - Totals derive from `getInventoryItemSummary` (window defaults to [now, now]).

2) Item detail
   - Header: name, SKU, type, base unit, active status, quick actions.
   - Overview: table of on-hand by location (and lot if present), attributes summary; date range to recompute availability.
   - Serials: for serialized items — placeholder until serials endpoint is available; hide for non-serialized.
   - Activity: transactions timeline with filters (date range, event types) via `listInventoryTransactions`.
   - Reservations: list existing; create (event-linked); release/fulfill using existing endpoints.
   - Maintenance: Start (`MAINTENANCE_START`), End (`MAINTENANCE_END`); capture notes in `sourceDoc` and display.

3) Transactions
   - Checkout (MOVE_OUT): Serialized → select serials (future); non-serialized → quantity or `{ qty, unit }`.
   - Checkin (MOVE_IN): select serials or quantity.
   - Transfer: post `TRANSFER_OUT` from source and `TRANSFER_IN` to destination (paired via shared `sourceDoc`).
   - Count Adjust: fetch current on‑hand, enter counted qty, compute delta = counted − on_hand, post `COUNT_ADJUST` with delta.
   - Error handling: surface server messages for policy enforcement (e.g., reservation requirements) and unit conversion failures.

4) Scan-first operations
   - Global “Scan mode” toggle pins a scan input; Enter posts action or selects item/location by code/SKU.
   - Audible and visual feedback on success/error; keep hands-free flow for prep/returns.

5) Event-centric workflows
   - “Check out to Event” and “Return from Event” quick actions; reuse recent event loads.
   - Duplicate last event’s list; support partial returns and show remaining holds.

6) Kits and presets
   - Client-side presets for common rigs (e.g., Small Stage Rig); post as multiple transactions with shared `sourceDoc`.
   - Allow editing quantities/locations before posting.

7) Shortage visibility
   - In checkout/transfer, show overbooking warnings and alternative locations.
   - Dashboard card for low-stock consumables against par levels.

8) Reconciliation
   - End-of-night page to compare expected vs scanned; propose `COUNT_ADJUST` deltas.
   - Allow defer/notes on unresolved discrepancies.

4) Maintenance / Issue/Repair
   - Start maintenance: post `MAINTENANCE_START` with `sourceDoc` { reason, notes[, technician] }.
   - End maintenance: post `MAINTENANCE_END` with `sourceDoc` { resolution, notes[, parts] }.
   - Display open maintenance status and recent logs in the Maintenance tab and Activity timeline.

---

### Validation, Policies, and Errors (reflecting 0015)

- Item attributes validation: when updating attributes via `patchInventoryItem`, display validation errors returned (message + first error path).
- Posting policies: handle 4xx responses with clear toasts and inline field messages (e.g., reservation required, min_on_hand enforced).
- Unit conversion: if `{ qty, unit }` is provided and no conversion path exists to the base unit, show the server error; allow the user to switch to `{ qtyBase }` input.
- Valuation: UI is read-only with respect to cost. For negative movements, server applies COGS from rolling average; display cost if returned.

---

### Performance & Pagination

- Transactions Activity: request with `limit=100`, support “Load more” to fetch the next page (cursor or range via `from/to`).
- Summary calls: debounce date range changes; avoid redundant calls; show skeleton loaders.
- Scan mode: keep scan input focused; handle bursts smoothly; avoid re-renders on each keystroke.

---

### API Client Additions (status)

- Already available from 0015:
  - `listInventoryTransactions`
  - `getInventoryItemSummary`
  - `listInventoryLocations({ departmentId })`
- Reuse existing helpers: `listInventoryItems`, `getInventoryItem`, `patchInventoryItem`, `postInventoryTransaction`, `listReservations`, `createReservation`, `updateReservation`.

---

### Files and Change Map

UI:
- Update `ui/src/App.tsx` routes.
- New `ui/src/pages/InventoryProduction.tsx`.
- New `ui/src/features/inventory/production/*` components listed above.
- Ensure `ui/src/lib/serverComm.ts` exports `listInventoryTransactions`, `getInventoryItemSummary`, and supports `departmentId` for locations.

Server:
- No changes required for this phase (0015 delivered needed server features).

Environment:
- No new env required beyond existing `DATABASE_URL` and `VITE_API_URL`.

---

### Optional future backend extensions (not required now)

- Barcode/QR alias lookups for items/locations/serials.
- Kit templates stored server-side; expand into transactions.
- Photo attachments for damage/maintenance logs.
- Location hierarchy (parent/child) for Stage/Truck/Storage aggregation.

---

### Acceptance Criteria

- Production pages and routes render with navigation from Inventory landing.
- Items list shows on‑hand and available totals; supports basic filters and quick actions.
- Item detail Overview shows on‑hand by location and windowed availability; Activity tab lists transactions with filters and pagination.
- Reservations tab can list/create/update; Maintenance tab can start/end and shows open status and history.
- Transactions flows (checkout/checkin/transfer/count adjust) succeed using `{ qty, unit }` or `{ qtyBase }`, with clear error handling for policy/unit conversion issues.
- Scan-first operations enable completing checkout/return with scans + Enter.
- Event workflows: quick issue/return to/from an Event; duplicate previous kit; partial returns supported.
- Shortage handling: visible warnings and suggested alternative locations at post time.
- Consumables card shows below-par items with quick links.
- Reconciliation page compares expected vs scanned and can generate adjustments.
- Usability: dark mode default; keyboard shortcuts for primary actions; mobile-friendly dialogs.

---

### Implementation Notes

- Start with routing + page shells, then wire data for Overview (summary) and Activity (transactions), then implement dialogs/wizards for transactions.
- Hide Serials tab unless the item is serialized; show a placeholder message until backend serials are available.
- Prefer optimistic UI only where safe; otherwise rely on server responses for authoritative state.
- Add keyboard shortcuts (e.g., g i: go to Items, g e: Events, /: focus scan, c: checkout, r: return).
- Ensure dark theme and large hit targets for stage/warehouse usage.


