## Feature Plan: Event Templates (versions, assignments, areas)

"we need the concept of an event template. This needs to have template versions of assignments, areas, a template title. There needs to be a full templates page (use the listdetail feature) where a user can create a new template, add which positions are needed and which areas those positions can be in. These templates then need to be able to be assigned to events or recurring events in the UI."

### Context
- Current entities and UI:
  - Events data model: `server/src/schema/events.ts`; Events UI: `ui/src/pages/Events.tsx` (uses ListDetail primitives) and panels such as `EventAreasPanel` and `EventShiftsPanel`.
  - Assignments model (includes optional `areaId`): `server/src/schema/assignments.ts`.
  - Areas model/table exists: `server/src/schema/areas.ts`, migration `server/drizzle/0021_areas.sql` and Event↔Area association.
  - Recurring Series feature (implemented): schemas `server/src/schema/recurringSeries.ts`, services `server/src/services/events/recurrence.ts`, routes/controllers under `/api/v1/event-series`, UI page `ui/src/pages/EventsRecurring.tsx`.
  - Reusable ListDetail framework: `ui/src/features/listDetail/*`.

### Scope
- Introduce Event Templates with versioning. A template version contains:
  - Template title (string)
  - A set of required positions, each with a count and an allowed-areas set (which areas those positions can be in).
- Provide a Templates ListDetail page to manage templates, their versions, and requirements.
- Allow selecting/applying a template (or a specific version) on an Event; optionally materialize assignments across selected event shifts.
- Allow associating a template with a Recurring Series; generation should apply the template to newly generated events.

---

### Tests (define first)
Server (HTTP + service behavior):
1) Create template → create first version automatically; list versions returns 1 current version.
2) Add requirements to a version: add positions with counts and allowed areas; GET returns the exact shape.
3) Create new version from current (clone) → edits to new version do not affect previous version; activating new version marks it current.
4) Apply template to event (no shifts): endpoint returns a warning and attaches `templateId`/`templateVersionId` to the event without creating assignments.
5) Apply template to event (with 3 shifts, requirements: Position A x3 allowed Areas [X,Y]): creates 3 assignments across shifts (even distribution 1/1/1), each with `requiredPositionId` = A and `areaId` ∈ {X,Y or null if none set}. Idempotent replace mode removes previously created template-sourced assignments and recreates; add mode appends without deleting.
6) Series generation with template: when generating dates for a series with a template set, events are created and then template application creates assignments for each event; preview reports counts as part of payload.
7) Permissions/auth: endpoints are auth-protected consistently with existing `/api/v1` routes.

UI (Cypress or RTL where applicable):
1) Templates page: create template; add requirement rows (position + count); set allowed areas; create another version and switch between versions; persistence verified via reload.
2) Events page: select a template version; click Apply → assignments created; re-apply with replace mode → previous template-created assignments are replaced.
3) Recurring page: select template for a series; preview shows per-date planned assignment counts; generate creates events and assignments; Events detail reflects the template association.

---

### Data layer (Postgres + Drizzle)
Add new tables and minimal columns to existing tables for associations. IDs are `text`.

Migrations to add (numbered sequentially):
- `server/drizzle/00xx_event_templates.sql`
  - `event_templates`:
    - `id text primary key`
    - `name text not null`
    - `description text null`
    - `active boolean not null default true`
    - `updated_at timestamptz not null default now()`
  - Indexes: unique index on `name` (optional), index on `active`.

- `server/drizzle/00xy_event_template_versions.sql`
  - `event_template_versions`:
    - `id text primary key`
    - `template_id text not null references event_templates(id) on delete cascade`
    - `version_number integer not null` (monotonic per template)
    - `title_template text not null`  // the template title string
    - `notes text null`
    - `is_current boolean not null default false`
    - `updated_at timestamptz not null default now()`
  - Unique: (`template_id`,`version_number`)
  - Index: (`template_id`,`is_current`)

- `server/drizzle/00xz_event_template_requirements.sql`
  - `event_template_requirements` (the per-version requirements):
    - `id text primary key`
    - `template_version_id text not null references event_template_versions(id) on delete cascade`
    - `required_position_id text not null references positions(id) on delete restrict`
    - `count integer not null default 1 check (count > 0)`
  - `event_template_requirement_areas` (allowed areas per requirement row):
    - `template_requirement_id text not null references event_template_requirements(id) on delete cascade`
    - `area_id text not null references areas(id) on delete restrict`
    - Primary key: (`template_requirement_id`,`area_id`)

- `server/drizzle/00xw_events_add_template_refs.sql`
  - Add nullable columns to `events`:
    - `template_id text null references event_templates(id) on delete set null`
    - `template_version_id text null references event_template_versions(id) on delete set null`
  - Index on `template_version_id`.

- `server/drizzle/00xv_assignments_add_template_source.sql` (optional for idempotency/replace semantics)
  - Add nullable `source_template_version_id text references event_template_versions(id) on delete set null` to `assignments`.
  - Index on `source_template_version_id`.

Drizzle schema files to add/change:
- Add: `server/src/schema/eventTemplates.ts`
  - Export `eventTemplates`, `eventTemplateVersions`, `eventTemplateRequirements`, `eventTemplateRequirementAreas` and inferred types.
- Change: `server/src/schema/events.ts` to include the two nullable template reference columns; update exported `Event` type.
- Change: `server/src/schema/assignments.ts` to include optional `sourceTemplateVersionId` if we adopt idempotent replace.
- Change: `server/src/schema/index.ts` to export new tables.

---

### Server API and services
Routes (under `/api/v1`) and controllers to add:
- Templates CRUD
  - `GET /event-templates` list; filters: `q`, `active`.
  - `POST /event-templates` create template (name, description); also creates version 1 with a provided `titleTemplate`.
  - `GET /event-templates/:templateId` get including current version metadata.
  - `PATCH /event-templates/:templateId` update name/description/active.

- Versions + requirements
  - `GET /event-templates/:templateId/versions` list versions (include `is_current`).
  - `POST /event-templates/:templateId/versions` create a new version (optionally `cloneFromVersionId` or clone current). Server assigns `version_number` = max + 1.
  - `POST /event-template-versions/:versionId/activate` set `is_current=true` and unset others for same template.
  - `GET /event-template-versions/:versionId/requirements` returns array of rows with `requiredPositionId`, `count`, and `allowedAreaIds: string[]`.
  - `PUT /event-template-versions/:versionId/requirements` replace-all semantics for requirements and their area sets.

- Apply to event
  - `POST /events/:eventId/apply-template` body: `{ templateVersionId?: string; mode?: 'replace'|'add'; shiftIds?: string[]; createAssignments?: boolean }`.
    - If `templateVersionId` omitted, use event's `template_version_id` if set; else 400.
    - Attaches `template_id` + `template_version_id` to event if not attached.
    - If `createAssignments`:
      - Load event shifts (via `server/src/repositories/shiftsRepo.ts` if present, or direct queries) and select target `shiftIds` or all event shifts.
      - For each requirement row: create `count` assignments across the selected shifts, distributing as evenly as possible. Set `requiredPositionId`; set `areaId` to first allowed area if provided else `null`. When `mode==='replace'`, delete existing assignments whose `sourceTemplateVersionId` equals this `versionId` before creating.
    - Returns `{ created: number, replaced: number, skipped: number, assignmentIds: string[] }`.

- Integrate with Recurring Series
  - `PATCH /event-series/:seriesId` accepts `{ templateVersionId?: string | null }` to associate/detach a template version.
  - `GET /event-series/:seriesId/preview` includes a computed summary of assignments per date based on the template requirements (counts only).
  - `POST /event-series/:seriesId/generate` applies the template to each generated event post-create, using the same distribution and replace semantics. Implementation hooks into `server/src/services/events/recurrence.ts` (after event creation/upsert).

Implementation touch points:
- Add controllers: `server/src/controllers/eventTemplatesController.ts` (templates + versions + requirements), `server/src/controllers/templateApplicationController.ts` (apply-to-event endpoint).
- Mount routes in `server/src/api.ts`.
- Extend services:
  - `server/src/services/events/templateApplication.ts` with functions:
    - `applyTemplateToEvent(eventId, versionId, options)` (core algorithm)
    - `distributeCountsEvenly(totalCount, shiftIds[]) => Record<shiftId, number>`
  - `server/src/services/events/recurrence.ts`: in `upsertEventsForSeries`, when series has a `templateVersionId`, call `applyTemplateToEvent` for each created/updated event (respecting `setAreasMode` and `overwriteExisting` semantics already present for areas).

Validation:
- Ensure positions referenced by requirements belong to the same department as the target shift or that cross-department usage is allowed (v1: do not enforce; rely on UI filtering to present valid positions per department if needed).
- Guard against applying when an event has no shifts (return warning, do not error).

---

### UI (React, Tailwind, ShadCN; ListDetail)
New Templates page:
- Route: `/templates` using ListDetail primitives.
- New page: `ui/src/pages/Templates.tsx`.
- Uses `ui/src/features/listDetail/*` components and hooks.
- Panels/sections within the detail pane:
  - Basics: name, description, active; current version selector; button “New version from current”.
  - Version basics: `titleTemplate` (string), optional notes.
  - Requirements editor:
    - Add row: select `Position` (searchable), set `count` (>=1).
    - Allowed Areas: multi-select of `Area` options; show chips for selected.
    - Inline add/edit/delete rows; persist via `PUT requirements`.

Events page integration (`ui/src/pages/Events.tsx`):
- Add a Template field group in the Event detail (near Series/Description):
  - Template autocomplete (search over template name + version display), storing `templateId` and selected `templateVersionId` on the event via `PATCH /events/:id`.
  - “Apply Template” button with options: `mode` (replace/add), `target shifts` (all vs multi-select), and `createAssignments` (default true). Calls `POST /events/:id/apply-template` and refreshes shifts/assignments rollups.

Recurring page integration (`ui/src/pages/EventsRecurring.tsx`):
- Add Template selector to series editor; store `templateVersionId` on series.
- Preview shows per-date assignment totals derived from template requirements.
- Generate uses backend to apply template while creating events.

UI data access (`ui/src/lib/serverComm.ts`):
- Add client methods and types:
  - `listEventTemplates(params)`, `createEventTemplate`, `getEventTemplate`, `updateEventTemplate`.
  - `listTemplateVersions(templateId)`, `createTemplateVersion`, `activateTemplateVersion`.
  - `getTemplateRequirements(versionId)`, `putTemplateRequirements(versionId, requirements)`.
  - `applyTemplateToEvent(eventId, payload)`.
  - Extend existing series methods to include `templateVersionId` on read/write, and preview/generate payloads to include assignment counts.

---

### Algorithms
Distribute counts across shifts (even spread):
1) Inputs: `totalCount`, ordered `shiftIds`.
2) Base allocation `floor(totalCount / shiftIds.length)` to each; remainder `r = totalCount % n` → add 1 to the first `r` shifts.
3) Deterministic order (by `date`,`startTime`,`id`) to keep idempotency predictable.

Apply template to event:
1) Resolve `versionId` (explicit or from event’s attached version).
2) Load requirements rows and allowed areas for each requirement.
3) Resolve target shifts (all event shifts or provided subset); if none, attach template refs only and return with warning.
4) If `mode==='replace'`, delete assignments where `sourceTemplateVersionId === versionId` (no-op if we omit the optional column in v1; alternative is to delete by event and position match but that’s risky—prefer the column).
5) For each requirement row, distribute `count` using the algorithm above and create assignments with `requiredPositionId` and `areaId` (choose the first allowed area if any; future enhancement: allow per-assignment area selection rules).
6) Return counts and IDs.

---

### Files to add/change
- Server
  - Add migrations: `server/drizzle/00xx_event_templates.sql`, `00xy_event_template_versions.sql`, `00xz_event_template_requirements.sql`, `00xw_events_add_template_refs.sql`, `00xv_assignments_add_template_source.sql`.
  - Add schema: `server/src/schema/eventTemplates.ts`; update `server/src/schema/events.ts`, `server/src/schema/assignments.ts`, and `server/src/schema/index.ts`.
  - Add controllers: `server/src/controllers/eventTemplatesController.ts`, `server/src/controllers/templateApplicationController.ts`.
  - Update router: `server/src/api.ts` to mount new routes under `/api/v1`.
  - Add service: `server/src/services/events/templateApplication.ts`; update `server/src/services/events/recurrence.ts` to call into it when series has a template.

- UI
  - Add page: `ui/src/pages/Templates.tsx` using `ui/src/features/listDetail/*`.
  - Update `ui/src/pages/Events.tsx` to add template selector + apply controls.
  - Update `ui/src/pages/EventsRecurring.tsx` to add template selector and flow into preview/generate.
  - Update `ui/src/lib/serverComm.ts` to add client methods and types above.

---

### Open questions / clarifications
1) Should requirements be department-scoped or global? (Current plan treats them global; UI can filter positions by department later.)
2) On apply-to-event, should we support creating default shifts if none exist? (Current plan: no—warn only.)
3) For allowed areas selection, is “no restriction” allowed (meaning any area) vs explicit set? (Current plan: empty set means unrestricted; we set `areaId = null`.)
4) Do we need per-requirement notes/labels beyond position/count? (Out of scope for v1.)

---

### Rollout notes
- Backward-compatible: new tables and nullable columns only.
- If `assignments.source_template_version_id` is omitted initially, disable replace mode or implement a conservative replace strategy; recommended to include the column for safe idempotency.


