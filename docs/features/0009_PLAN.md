## Scheduling (Shifts + Schedules)

Brief
- You asked to pull the Shifts functionality from showcall_v1, but with a key change: "a shift will be published or unpublished and to publish it, someone will publish a SCHEDULE which will have a start and end date and a name." The schedule is "simply a wrapper for the shifts to be published under." The Scheduling page should be a list/detail view of Shifts using the common list/detail pattern. "Which schedule the shift was posted under should only be a field in the shift and a way to search shifts." Shifts come with assignments, which can be ported as-is. All of this will live under the new main view called Scheduling.

Scope Overview
- Data layer (Postgres/Drizzle): add `schedules`, `shifts`, and `assignments` tables; wire relations and indexes.
- API (Hono): CRUD for schedules, publish/unpublish; CRUD for shifts; list and assign/unassign for assignments. Enforce validations; derive published state of a shift from its schedule.
- UI (React + list/detail feature): new `Scheduling` main view showing a list/detail of Shifts with filters (Department, Schedule, Dates, Search). Shift detail includes an Assignments panel ported from v1.

Key Principle
- Publication state is schedule-driven. A shift is considered published if its `scheduleId` points to a schedule where `isPublished` is true. Avoid a separate boolean on shifts to prevent divergence.

Data Layer
1) New tables in `server/drizzle/*.sql` and `server/src/schema/*` (Drizzle):
   - schedules
     - id (text, pk)
     - name (text, required)
     - startDate (date, required, YYYY-MM-DD)
     - endDate (date, required, YYYY-MM-DD)
     - isPublished (boolean, default false)
     - publishedAt (timestamptz, nullable)
     - createdAt (timestamptz, default now), updatedAt (timestamptz)
     - Indexes: (startDate, endDate), (isPublished)
   - shifts
     - id (text, pk)
     - departmentId (text, fk -> departments.id, required)
     - scheduleId (text, fk -> schedules.id, nullable) — used to group and derive publication; searchable
     - date (date, required) — single-day shifts
     - startTime (text, HH:mm, required)
     - endTime (text, HH:mm, required)
     - title (text, optional) — e.g., display label; can be null
     - notes (text, optional)
     - eventId (text, fk -> events.id, optional) — optional cross-link to Events page
     - createdAt (timestamptz, default now), updatedAt (timestamptz)
     - Indexes: (departmentId, date, startTime), (scheduleId), (eventId)
   - assignments
     - id (text, pk)
     - departmentId (text, fk -> departments.id, required)
     - shiftId (text, fk -> shifts.id, required)
     - requiredPositionId (text, fk -> positions.id, required)
     - assigneeEmployeeId (text, fk -> employees.id, nullable)
     - createdAt (timestamptz, default now), updatedAt (timestamptz)
     - Indexes: (shiftId), (departmentId, requiredPositionId), (assigneeEmployeeId)

2) Files to add/update in schema
   - Add: `server/src/schema/schedules.ts`, `server/src/schema/shifts.ts`, `server/src/schema/assignments.ts`
   - Update: `server/src/schema/index.ts` to export new tables
   - Use existing validation helpers in `server/src/lib/validators.ts` for simple string/date/time validation where applicable

3) SQL migrations (in order)
   - `server/drizzle/0006_schedules.sql`: create schedules
   - `server/drizzle/0007_shifts.sql`: create shifts (fk -> schedules, departments, events)
   - `server/drizzle/0008_assignments.sql`: create assignments (fk -> shifts, positions, employees, departments)
   - Provide indexes as listed above
   - Apply via existing migration workflow (`server/scripts/apply-sql-migrations.mjs`)

API (Hono)
- Location: `server/src/api.ts`
- All routes require auth (reuse existing `authMiddleware` like departments/employees/positions). Use shared DB access via `getDatabase()` and Drizzle schema.

1) Schedules
   - `GET /api/v1/schedules` — list schedules
     - Query: `q?` (name search), `isPublished?` (true/false), `from?` (YYYY-MM-DD), `to?` (YYYY-MM-DD)
   - `POST /api/v1/schedules` — create schedule
     - Body: `{ name: string, startDate: string, endDate: string }`
     - Validate `name` non-empty; `startDate <= endDate` (string compare ok for YYYY-MM-DD)
   - `GET /api/v1/schedules/:scheduleId` — get one
   - `PATCH /api/v1/schedules/:scheduleId` — update name/dates
   - `POST /api/v1/schedules/:scheduleId/publish` — publish
     - Set `isPublished=true`, `publishedAt=now`
   - `POST /api/v1/schedules/:scheduleId/unpublish` — unpublish
     - Set `isPublished=false`, `publishedAt=null`

2) Shifts
   - `GET /api/v1/departments/:departmentId/shifts`
     - Query: `q?` (title/notes), `scheduleId?`, `from?` (YYYY-MM-DD), `to?` (YYYY-MM-DD), `published?` (true|false derived via schedule)
     - If `published` provided:
       - Join to schedules; filter schedules.isPublished accordingly (if `scheduleId` provided, use that schedule only)
   - `POST /api/v1/departments/:departmentId/shifts`
     - Body: `{ date, startTime, endTime, title?, notes?, scheduleId?, eventId? }`
     - Validate: `startTime < endTime`, date format `YYYY-MM-DD`, HH:mm for time
     - Optional: non-blocking overlap warning (compute overlaps among same department/date with intersecting time ranges). Return `201` regardless; include `warnings: [...]` array in JSON if overlaps detected
   - `GET /api/v1/shifts/:shiftId` — fetch one
   - `PATCH /api/v1/shifts/:shiftId` — partial update
     - Allow reassigning `scheduleId` to move between schedules or set `null`
   - `DELETE /api/v1/shifts/:shiftId`

3) Assignments (ported-as-is semantics from v1)
   - `GET /api/v1/departments/:departmentId/assignments?shiftId=...` — list assignments (keep department scoping consistent with v1)
   - `POST /api/v1/departments/:departmentId/assignments`
     - Body: `{ shiftId: string, requiredPositionId: string, assigneeEmployeeId?: string }`
   - `PATCH /api/v1/assignments/:assignmentId`
     - Body: `{ assigneeEmployeeId?: string | null }` — assign/unassign
   - Optional: `DELETE /api/v1/assignments/:assignmentId`
   - Reuse existing eligibility route: `GET /api/v1/departments/:departmentId/positions/:positionId/eligible`

4) Events bridging (optional)
   - Wire `GET /api/v1/events/:eventId/shifts` (currently returns `[]`) to return shifts where `eventId = :eventId`

UI
- Location: `ui/src/pages`, `ui/src/lib/serverComm.ts`, `ui/src/components`, `ui/src/features/listDetail`
- Add Scheduling main view and wire routes/nav

1) Routes and Navigation
   - Add routes in `ui/src/App.tsx`:
     - `/scheduling` and `/departments/:departmentId/scheduling` (list/detail of shifts)
     - `/scheduling/:shiftId` and `/departments/:departmentId/scheduling/:shiftId` (deep-link to a shift)
   - Add a new nav entry in `ui/src/components/appSidebar.tsx`: "Scheduling"

2) API client additions (`ui/src/lib/serverComm.ts`)
   - Types:
     - `ScheduleRecord` { id, name, startDate, endDate, isPublished, publishedAt?, updatedAt? }
     - `ShiftRecord` { id, departmentId, scheduleId?, date, startTime, endTime, title?, notes?, eventId?, updatedAt?, derivedPublished?: boolean }
     - `AssignmentRecord` { id, departmentId, shiftId, requiredPositionId, assigneeEmployeeId?, updatedAt? }
   - Functions:
     - `listSchedules(params?)`, `createSchedule(payload)`, `getSchedule(id)`, `updateSchedule(id, patch)`, `publishSchedule(id)`, `unpublishSchedule(id)`
     - `listShifts(departmentId, params?)`, `createShift(departmentId, payload)`, `getShift(id)`, `updateShift(id, patch)`, `deleteShift(id)`
     - `listAssignments(departmentId, shiftId?)`, `createAssignment(departmentId, payload)`, `updateAssignment(id, patch)`, `deleteAssignment(id)`
   - Keep request auth via `fetchWithAuth` as in existing helpers

3) Scheduling list/detail page (`ui/src/pages/Scheduling.tsx`)
   - Use `ListDetailLayout` with left list of shifts and right detail
   - Left (List):
     - FilterBar with: Department selector (All | specific), Schedule selector (All | specific), date range, text search, Published toggle
     - Items show: date, start–end, title, and derived Published badge when schedule is published
     - Default sort: date ascending then startTime ascending; option to include past
   - Right (Detail):
     - Editable fields: title, date, start/end time, notes, schedule (select from schedules), optional event link (read-only title once selected)
     - Show derived publication state from schedule; display linked schedule chip (click opens minimal schedule drawer)
     - Assignments panel (ported): list required positions; selection to assign/unassign eligible employees, using existing eligibility API
   - Create inline: New Shift (date, startTime, endTime, title?, schedule?)
   - Overlap warning: compute on save and display non-blocking message (match v1 behavior)

4) Minimal schedule management affordances (inside Scheduling)
   - In filter bar: quick create schedule (name, start, end)
   - In schedule selector: publish/unpublish button for selected schedule

5) Reuse from showcall_v1
   - Port UX/logic from v1 files where applicable:
     - UI: `src/web/src/views/ShiftsPage.tsx` (list, selection, creation, overlap warning logic), `src/web/src/components/ShiftDetail.tsx` (assignments behaviors)
     - API behavior reference: assignments routes in `src/server/src/index.ts`
   - Adapt to new list/detail abstraction in `ui/src/features/listDetail` and existing styling

Validation and Rules
- Time window: startTime must be strictly less than endTime (string HH:mm compare ok)
- Date strings must be `YYYY-MM-DD`; server validates and normalizes
- Published flag on a shift is derived (`scheduleId` -> `schedule.isPublished`); do not add a separate `shift.isPublished`
- Deleting a schedule with shifts should be prevented (or require `force=true` to remove/move shifts first). Initial version: block delete when shifts exist

Files to Modify / Create (exact paths)
- Server
  - Add: `server/src/schema/schedules.ts`, `server/src/schema/shifts.ts`, `server/src/schema/assignments.ts`
  - Update: `server/src/schema/index.ts` (export new tables)
  - Add migrations: `server/drizzle/0006_schedules.sql`, `server/drizzle/0007_shifts.sql`, `server/drizzle/0008_assignments.sql`
  - Update: `server/src/api.ts`
    - Mount: `/api/v1/schedules`, `/api/v1/departments/:departmentId/shifts`, `/api/v1/shifts/:shiftId`, `/api/v1/departments/:departmentId/assignments`, `/api/v1/assignments/:assignmentId`, `/api/v1/events/:eventId/shifts`
- UI
  - Update: `ui/src/App.tsx` (routes)
  - Update: `ui/src/components/appSidebar.tsx` (nav item)
  - Add: `ui/src/pages/Scheduling.tsx` (list/detail over shifts)
  - Update: `ui/src/lib/serverComm.ts` (types + API functions for schedules/shifts/assignments)
  - Optional: shared components for assignment controls if we refactor from other features

Algorithms / Behaviors
- Published derivation: `derivedPublished = !!(shift.scheduleId && schedule.isPublished)`; compute on the server when listing shifts (include a boolean), or compute in UI after fetching schedule state. Prefer server-side so list can filter by `published` efficiently.
- Overlap detection (non-blocking): Given a new or updated shift S on date D in department X, fetch other shifts in X on D; compute overlap if `(S.start < O.end && S.end > O.start)`.
- Schedule date containment (for UX warnings only): when attaching a shift to a schedule, warn if `shift.date` is outside `[schedule.startDate, schedule.endDate]` (do not block; users may adjust order of operations).

Phasing
- Phase 1 — Data Layer
  - Add schema files and migrations; run migrations; verify with `GET /api/v1/health` and a simple DB sanity query
- Phase 2 — API
  - Implement schedules, shifts, and assignments routes; add basic validation; return overlap warnings on shift create/update
- Phase 3 — UI
  - Create Scheduling page and nav; wire filters and list/detail; port assignments interactions; add schedule quick actions
- Phase 4 — Optional Integrations
  - Wire Events → Shifts list; refine search/sort; polish badges and empty states

Notes
- Auth: reuse Firebase Auth bearer token via existing `authMiddleware`
- Env: no new env vars required
- Seeding: optional dev helper to insert a schedule and a few shifts for smoke testing


