## Feature 0025 — Address Entity (U.S.-Specific)

Brief context: Implement an Address feature with no UI view. Supports linkage to existing entities, lifecycle dates, primary flag, USPS-standardization placeholders, geospatial fields, and compliance metadata per the brief.

Verbatim fields from the brief to support:
- Identity & Linkage: `address_id`, `entity_id`, `role`, `valid_from`, `valid_to`, `is_primary`
- Core Address Fields: `address_line_1`, `address_line_2`, `city`, `county`, `state`, `zip_code`, `zip_plus4`
- Geospatial & Standardization: `latitude`, `longitude`, `usps_standardized`, `raw_input`
- Metadata & Compliance: `created_at`, `updated_at`, `verified`, `verification_date`, `data_source`, `status`

Notes/assumptions:
- Linkage will be implemented as a polymorphic association: (`entity_type`, `entity_id`). Initial supported `entity_type` values: `contact`, `employee`. `organization` is planned but not yet present in the schema; we’ll allow the type in the API once the table exists.
- `status` will be a free-text constrained in code to: `active`, `inactive`, `pending_verification`.
- We will enforce “at most one primary address per entity per role” via a unique partial index.

### Phase 1 — Data Layer (Drizzle schema + SQL migration)

Create a new table and Drizzle model for addresses.

- New file: `server/src/schema/addresses.ts`
  - Define table `addresses` with columns:
    - `id` (PK, text)
    - `entityType` (text; allowed values in API: `contact`, `employee` [later `organization`])
    - `entityId` (text; references the entity’s `id` logically; validated in API)
    - `role` (text; e.g., `billing`, `shipping`, `registered_office`, etc.)
    - `validFrom` (date) / `validTo` (date) with CHECK ensuring `valid_from <= valid_to` when both present
    - `isPrimary` (boolean; default false)
    - `addressLine1`, `addressLine2`, `city`, `county` (text)
    - `state` (char(2) uppercase)
    - `zipCode` (char(5)) and `zipPlus4` (char(4) nullable)
    - `latitude` (numeric(9,6) nullable), `longitude` (numeric(9,6) nullable)
    - `uspsStandardized` (text nullable), `rawInput` (text nullable)
    - `verified` (boolean; default false)
    - `verificationDate` (date nullable)
    - `dataSource` (text; e.g., `manual`, `imported`, `api`)
    - `status` (text; default `active`)
    - `createdAt`/`updatedAt` (timestamptz; default now())
- Export from `server/src/schema/index.ts` to expose `addresses` to the rest of the app.
- Migration: add `server/drizzle/0029_addresses.sql` (or next number) to create the table and indexes:
  - Table DDL matching the Drizzle model
  - Index on (`entity_type`, `entity_id`)
  - Unique partial index on (`entity_type`, `entity_id`, `role`) WHERE `is_primary = true`
  - CHECK (`valid_from` IS NULL OR `valid_to` IS NULL OR `valid_from` <= `valid_to`)

Validation reference in DB vs API:
- State/ZIP formats validated in API (with existing validators), not DB.
- Lat/long ranges validated in API (DB uses numeric type only).

### Phase 2 — API Layer (Hono routes)

Add CRUD endpoints for addresses under `/api/v1/addresses` following patterns used by `contacts`, `employees`, and `areas` in `server/src/api.ts`.

Files to edit:
- `server/src/api.ts`
  - New router `addressesRoutes` (protected, uses `authMiddleware`).
  - Endpoints:
    - GET `/addresses`: optional filters `entityType`, `entityId`, `role`, `status`, `isPrimary`, and basic text search `q` against city/line1.
    - POST `/addresses`: create one address; normalize/validate fields, ensure entity existence based on `entityType`, and handle uniqueness of primary-per-role.
    - GET `/addresses/:addressId`: fetch by id.
    - PATCH `/addresses/:addressId`: partial update with same validations; guard the primary uniqueness rule.
    - DELETE `/addresses/:addressId`: hard delete.
  - Error handling: on unique-primary conflict, return 409 with a clear error (e.g., `PrimaryExists`).
  - Normalization/utilities to reuse from `server/src/lib/validators.ts`:
    - `normalizeState`, `isValidState`
    - `normalizeZip5`, `isValidZip5`
    - `normalizeZip4`, `isValidZip4`
  - Additional numeric validations:
    - `latitude` in [-90, 90], `longitude` in [-180, 180]
  - Entity existence checks:
    - If `entityType === 'contact'`, ensure `schema.contacts` has `entityId`
    - If `entityType === 'employee'`, ensure `schema.employees` has `entityId`
    - `organization` support to be enabled once an `organizations` table exists

Optional/nested convenience (can be skipped initially):
- GET `/contacts/:contactId/addresses` and `/employees/:employeeId/addresses` as thin wrappers that filter the base list; mount after core is working.

### Algorithms and Behaviors

Create (POST):
1) Parse body and trim strings. Map `address_line_*` input names to model fields.
2) Validate formats: state (2-letter uppercase), zip5 (5 digits), zip4 (4 digits when provided), lat/long ranges.
3) Validate `valid_from`/`valid_to` ordering if both present.
4) Verify entity existence for supported `entity_type`.
5) If `is_primary = true`, rely on DB unique partial index; on conflict, return 409.
6) Set `data_source` to `manual` by default; `status` default `active`.

Patch (PATCH):
1) Apply the same validations only to provided fields.
2) If switching `entity_type`/`entity_id`, re-validate entity existence.
3) If toggling `is_primary` to true, handle unique conflict (409) as above.
4) Update `updated_at`.

List (GET):
1) Build a composable `where` with provided filters.
2) Sort by `is_primary DESC`, `updated_at DESC` by default.

Delete (DELETE):
1) Remove the record. No cascading side-effects required.

USPS standardization placeholder:
- Store raw input in `raw_input`.
- Leave `usps_standardized` and `verified`/`verification_date` as-is; a future integration can populate these.

### Out of Scope (for this feature)
- UI components, forms, and views.
- USPS validation/integration and geocoding services.
- Organization table and routes (planned separately).

### Acceptance Checks (manual)
- Create, fetch, patch, delete address records for a `contact` and an `employee`.
- Primary uniqueness: creating a second `is_primary=true` for same (entityType, entityId, role) yields 409.
- Field validations reject bad `state`, `zip`, or out-of-range geospatial values with 400.


