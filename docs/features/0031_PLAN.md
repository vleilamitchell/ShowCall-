### Communications/Notifications Infrastructure (email, SMS, push)

Brief
- The system needs the ability to send communications out from the system: email, sms, and push notifications (verbatim requirement). Preference is to use a mature package rather than homegrown, but flexible. This plan designs the framework and selects a package, then specifies exact file changes and the tests to be written before any code.

Package selection (unified notification infrastructure)
- Recommendation: Novu (open-source and hosted options). Rationale: single API for multi-channel (email, SMS, push, in-app), templates and versioning, user preferences, digests/delays, provider routing (e.g., Resend, SendGrid, SES for email; Twilio for SMS; FCM/APNs/Web Push for push), subscriber model, webhooks for delivery/bounce, SDK for Node and React.
- Viable alternatives:
  - Knock (hosted, developer-focused workflows, strong UX/observability, higher base cost).
  - Courier (hosted, designer-friendly editor, strong routing, pay-per-notification).
  - OneSignal (strong push-first platform with email/SMS add-ons, suited if push dominates).
- Decision: Proceed with Novu to get templating, orchestration, and multi-channel provider abstraction with minimal custom code.

Environments and configuration
- Add environment variables to the server (document-only; no code here):
  - NOVU_API_KEY: Novu server API key
  - NOVU_APP_ID (if used by client widgets or future in-app center)
  - PUBLIC_APP_BASE_URL: existing public base URL for action links
- Provider credentials are stored in Novu (recommended). If we choose direct provider fallbacks later, we would also need: RESEND_API_KEY (email), TWILIO_ACCOUNT_SID/TWILIO_AUTH_TOKEN (SMS), FCM credentials (push). For development and tests, use a console/stub transport for email and SMS to avoid real sends.

Scope and approach
- Introduce a simple Message outbox table for auditability and traceability regardless of provider. Route all outbound communication requests through a single notifications service that talks to Novu.
- Use Novu templates (created in the Novu dashboard) referenced by stable template keys. Payloads should be small, include only non-sensitive data, and use signed links for actions.
- Adopt an idempotency key per business event to avoid duplicate sends (e.g., assignment-invite-[assignmentId]-[version]).

Phase 1 — Data layer (types and DB)
- Create `server/src/schema/messages.ts` (Drizzle) and register it in `server/src/schema/index.ts`.
  - Columns (concise):
    - id (uuid/cuid), channel ('email'|'sms'|'push'), templateKey (string)
    - to (string, email/phone/push-recipient-id), cc/bcc (nullable strings for email)
    - subject (string, nullable), bodyPreview (string, nullable, short excerpt)
    - status ('queued'|'sent'|'failed'|'enqueued'|'delivered'|'bounced'), providerId (string, nullable), error (text, nullable)
    - context: employeeId, scheduleId, shiftId, assignmentId, eventId (nullable strings)
    - dedupeKey (string, nullable, unique when set)
    - createdAt (now), sentAt (nullable), updatedAt (now on update)
  - Indexes: by channel+status, by createdAt desc, by context ids.
- Create `server/src/schema/pushTokens.ts` (optional now, required for direct Web Push):
  - id, userId, provider ('fcm'|'apns'|'webpush'), token (string), platform ('web'|'ios'|'android'), lastSeenAt, createdAt.
- Create repositories:
  - `server/src/repositories/messagesRepo.ts`
  - `server/src/repositories/pushTokensRepo.ts` (if storing tokens server-side)

Phase 2A — Server integration (Hono API)
- Add Novu client wrapper:
  - `server/src/services/notifications/novuClient.ts`: lazy-initialize Novu SDK with `NOVU_API_KEY`; expose `trigger(templateKey, toSubscriberId, payload, overrides?)`.
- Add notifications service:
  - `server/src/services/notifications/notificationsService.ts` with operations:
    - sendEmail({ templateKey, toEmail, subject?, payload, context, dedupeKey? })
    - sendSms({ templateKey, toPhone, payload, context, dedupeKey? })
    - sendPush({ templateKey, toSubscriberId, payload, context, dedupeKey? })
  - Algorithm per send (step-by-step):
    1) Insert Message row with status 'queued' and dedupeKey (if provided). If dedupeKey exists, short-circuit (idempotent return existing row).
    2) Call Novu `trigger` with templateKey, `to` subscriberId or direct credentials (Novu supports channels via subscriber).
    3) On success: update Message row with status 'enqueued'|'sent' (based on Novu response) and providerId.
    4) On failure: update Message row with status 'failed' and error message.
    5) Return the persisted row.
- Add webhooks endpoint to receive delivery updates from Novu/providers:
  - `server/src/routes/webhooks/novu.ts` and controller `server/src/controllers/webhooks/novuController.ts`.
  - Map webhook events (delivered, bounced, failed) to Message status updates and record providerId.
  - Verify signatures if offered by Novu.
- Add a thin internal route for test sends:
  - `server/src/routes/notifications.ts` and controller `server/src/controllers/notificationsController.ts` with POST `/internal/notifications/test` supporting channels email|sms|push to aid QA and integration tests.
- Wire routes:
  - Register in `server/src/routes/index.ts` and ensure export from `server/src/api.ts`/`server/src/app.ts`.
- Extend `server/src/lib/env.ts` to read and validate `NOVU_API_KEY` and optional `NOVU_APP_ID`.

Phase 2B — Push token capture (Web push via FCM through Novu)
- Client (React Vite):
  - Add `ui/src/lib/push.ts` to request notification permission, initialize Firebase Messaging, obtain FCM registration token, and POST it to the backend (current user context).
  - Add service worker file for FCM (e.g., `ui/public/firebase-messaging-sw.js`).
  - Store token server-side in `pushTokens` OR set it as Novu subscriber credential. Preferred: register Novu subscriber per user and set credentials via server (`/me/push-tokens` maps to Novu subscriber update).
- Server:
  - Add `POST /me/push-tokens` in `server/src/routes/users.ts` (or new `pushTokens.ts`) that associates the FCM token with the authenticated user and updates Novu subscriber credentials.
  - Create `server/src/services/notifications/subscribers.ts` to ensure user↔Novu subscriber sync (email, phone, push tokens).

Templates in Novu (to create in Novu dashboard)
- Template keys (examples; referenced in code by key):
  - SHIFT_INVITE: email+sms+push (action links to confirm/decline)
  - SHIFT_REMINDER: reminders prior to shift start
  - GENERIC_BROADCAST: operational broadcast to staff
- Payload guidelines: keep lean (titles, times, location, CTA URLs), avoid PII in URLs, use signed action links with short TTL.

Tests (write first)
- Unit tests (server): `server/test/notifications.service.unit.ts`
  - mocks Novu client; verifies status transitions for success and failure.
  - enforces idempotency via dedupeKey when called repeatedly.
- Integration tests (Hono): `server/test/integration/notifications.int.ts`
  - POST internal test endpoint queues a Message and calls mocked Novu; verifies DB row updated and HTTP 201.
  - Webhook handler updates Message status on delivered/bounced payloads.
- Push token tests: `server/test/integration/pushTokens.int.ts`
  - POST `/me/push-tokens` stores token and updates Novu subscriber via mocked client.
- Note: tests do not require real provider credentials; Novu client is stubbed and email/SMS are not sent in CI.

Security and compliance
- Signed action links for sensitive flows; use `PUBLIC_APP_BASE_URL` to build absolute URLs.
- Redact PII in logs; do not log full message bodies or tokens.
- Verify webhook signatures and lock down webhook route.

Operational concerns
- Observability: include Message id and providerId in logs; add metrics counters for enqueued/sent/failed.
- Retries: rely primarily on Novu routing/retries; implement one retry on transient network errors when calling Novu.
- Quiet hours and preference management: leverage Novu preferences; model org/user preferences later if needed (out of scope for initial cut).

Developer tasks (no code here; pointers only)
- Install packages: `pnpm add @novu/node` (server). For push: `pnpm add firebase` (ui) if not present.
- Configure Novu project: connect providers (e.g., Resend for email, Twilio for SMS, FCM for push), create templates and variables, set webhook to our `/webhooks/novu`.
- Add new files per paths above; update exports and route registration files accordingly.

Rollout plan
- Enable in non-prod with stub providers to validate end-to-end.
- Start with test endpoint and SHIFT_INVITE template; integrate into actual domain flows next (e.g., assignment invite, reminders).

Notes
- Dev/test should use a console/stub transport for email/SMS to avoid real sends. In production, providers are configured in Novu. Delivery receipts flow back via webhooks.

