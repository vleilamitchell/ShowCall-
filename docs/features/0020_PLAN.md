### Feature 0020 – Events: Marketing Rollup above Shifts

**Context**
Add a new rollup section on the Event detail view that appears above the existing Shifts panel. This rollup will contain marketing tracking for three links (verbatim): "the ticket link, the event page, and the link to the promo assets." The section should be beautifully designed, quick to scan, and easy to edit, with strong affordances to copy and open links.

---

### Scope and Objectives
- **Add a Marketing panel** to the Event detail (above Shifts) that displays and edits three URLs:
  - ticket link
  - event page
  - link to the promo assets
- **Persist these fields** on the Event record in Postgres via Drizzle schema changes and API updates.
- **Validate** URLs server-side; normalize blanks to null.
- **Client**: update types and add a focused, delightful UI for these links with open/copy actions and inline edit.

Out-of-scope (optional later): UTM builder, QR codes, short links, click analytics.

---

### Files and Changes

#### Server (Hono + Drizzle)
1) `server/src/schema/events.ts`
   - Add three optional columns to `events` table definition:
     - `ticketUrl`: `text('ticket_url')`
     - `eventPageUrl`: `text('event_page_url')`
     - `promoAssetsUrl`: `text('promo_assets_url')`
   - Export types continue to infer from the schema.

2) Migration – create a new Drizzle SQL migration file:
   - `server/drizzle/0020_events_marketing_links.sql`
   - Contents:
     - `ALTER TABLE "events" ADD COLUMN IF NOT EXISTS "ticket_url" text;`
     - `ALTER TABLE "events" ADD COLUMN IF NOT EXISTS "event_page_url" text;`
     - `ALTER TABLE "events" ADD COLUMN IF NOT EXISTS "promo_assets_url" text;`
     - No indexes needed; these are not query filters.

3) `server/src/lib/validators.ts`
   - Add `isValidUrl(v?: unknown): boolean` that:
     - returns true for empty/undefined
     - uses `new URL(String(v))` try/catch
     - only accepts `http:` or `https:` protocols

4) `server/src/api.ts` (Events routes)
   - In `POST /api/v1/events`:
     - Accept `ticketUrl`, `eventPageUrl`, `promoAssetsUrl` from body
     - Normalize: trim; map blank string to `null`
     - Validate with `isValidUrl` when non-null; if invalid, return 400 with descriptive error
     - Include fields in the `record` inserted into `schema.events`
   - In `PATCH /api/v1/events/:eventId`:
     - Accept partial updates for the same three fields
     - Normalize and validate as above
     - Include in update `patch`
   - `GET` handlers already select `events` columns; no change needed beyond schema.

5) `server/src/schema/index.ts`
   - Already exports `events`; no changes beyond picking up new columns.

#### UI (React + Tailwind + shadcn)
6) `ui/src/lib/serverComm.ts`
   - Extend `export type EventRecord` to include (optional) `ticketUrl?: string | null`, `eventPageUrl?: string | null`, `promoAssetsUrl?: string | null`.
   - Ensure `createEvent`/`updateEvent` can pass these fields through unchanged.

7) `ui/src/pages/Events.tsx`
   - Render a new `EventMarketingPanel` component **above** `EventShiftsPanel` in the selected-event view.
   - No change to the draft creation flow initially (keep create modal simple); editing happens in the rollup panel after creation.

8) New component `ui/src/features/events/EventMarketingPanel.tsx`
   - Collapsible panel labeled "Marketing" (mirrors `EventShiftsPanel` patterns) with:
     - Three rows, one per link: Ticket, Event Page, Promo Assets.
     - Each row shows: label, current URL (as clickable link if present), and action buttons: Copy, Open, Edit.
     - Edit mode shows a compact `Input`; on change, optimistically update the local `selected` event and use `useDebouncedPatch` to `PATCH` the field to `/api/v1/events/:id`.
     - When the URL is empty/null, show muted placeholder text (e.g., "Add ticket link").
     - Handle server validation errors by showing a small inline error below the row.
   - Visual design notes (Tailwind/shadcn):
     - Use a light gradient or tinted card background (`bg-muted/30` with subtle border) and tasteful icons.
     - Keep actions aligned right; use `Badge` when a link exists (e.g., “Set”).
     - Motion: reuse `Collapsible` with the same transition classes as Shifts for consistency.

---

### UI/Behavior Algorithms

1) Placement in `Events.tsx`:
   - If an Event is selected (`selected`), render `<EventMarketingPanel event={selected} onPatch={updateEvent} mutateItems={mutateItems} />` before `<EventShiftsPanel/>`.

2) Link row interaction (per field):
   - Initial state: show URL as anchor (truncate middle) or placeholder when null.
   - Actions:
     - Open: If URL present, `window.open(url, '_blank')`.
     - Copy: If URL present, `navigator.clipboard.writeText(url)`; show quick toast if available or subtle success state.
     - Edit: Toggle to input; auto-focus; pressing Enter blurs; Escape cancels (revert display to last saved value).
   - Update algorithm (consistent with existing debounced patch pattern in `Events.tsx`):
     - On input change: `mutateItems` to update the selected event’s field optimistically.
     - Feed the change into `useDebouncedPatch` for `{ [field]: value || undefined }`.
     - On blur: `onBlurFlush()` to force immediate `PATCH`.
     - Error handling: if server returns 400 (invalid URL), show inline error, preserve input, and do not revert until user corrects or clears.

3) Accessibility
   - Buttons have `aria-label`s (Open, Copy, Edit) and focus rings.
   - Inputs are labeled; rows are keyboard navigable.

---

### Data Model and Validation Details
- Database columns (snake_case) in `events`:
  - `ticket_url` text NULL
  - `event_page_url` text NULL
  - `promo_assets_url` text NULL
- Drizzle mapping in `server/src/schema/events.ts` to camelCase props returned to clients:
  - `ticketUrl`, `eventPageUrl`, `promoAssetsUrl`
- Server normalization function: if provided value is an empty string or whitespace-only, convert to `null`.
- Server validation: when value is non-null, must be a valid `http` or `https` URL; otherwise respond `400` with an error message like `invalid ticketUrl: must be http(s) URL`.

---

### Edge Cases
- Blank inputs should not error; they clear the URL (set to `null`).
- Non-http(s) schemes (mailto:, ftp:) are rejected to avoid user confusion.
- Extremely long URLs: accepted; UI truncates visually with CSS.
- If a user pastes without protocol (e.g., `example.com`), we do not auto-correct; server rejects until user adds `https://`.

---

### Phases

Phase 1 – Data Layer
- Add columns to Drizzle schema and migration file.
- Add `isValidUrl` to validators.
- Update Events API `POST`/`PATCH` to accept/validate fields.

Phase 2 – UI
- Extend `EventRecord` in `serverComm.ts` and ensure pass-through in API helpers.
- Implement `EventMarketingPanel` with three link rows and actions.
- Mount `EventMarketingPanel` in `Events.tsx` above `EventShiftsPanel`.

Phase 3 – Optional Enhancements (later)
- UTM builder UI (quick presets; copy result).
- QR code rendering for each link (would require `pnpm add qrcode.react`).
- Short link generation and click analytics (requires a shortener service and additional tables/APIs; out-of-scope for this iteration).

---

### Acceptance Notes
- The Marketing panel appears above Shifts on the Event detail.
- Users can set, clear, copy, and open each of the three links.
- Invalid URLs are rejected with friendly error text; valid http(s) URLs save and persist.
- No regressions to existing Events or Shifts functionality.


