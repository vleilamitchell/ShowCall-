## Feature: Port legacy "employees" from showcall_v1

Brief: "Lets take the 'employees' from @showcall_v1/" and add the resource to the current stack (Hono API + Drizzle + React/Vite + Tailwind/ShadCN). This includes the Employees data model, CRUD API, validations/normalization, and a basic UI list/detail editor. Align endpoints and behaviors with the legacy app for compatibility while fitting the new API structure.

### Legacy reference (authoritative behaviors)
- Data model in `showcall_v1` (`Prisma`):
  - `Employee`: `id`, `departmentId`, `name`, `priority?`, expanded details: `firstName?`, `middleName?`, `lastName?`, `address1?`, `address2?`, `city?`, `state?`, `postalCode?`, `postalCode4?`, `primaryPhone?`, `email?`, `emergencyContactName?`, `emergencyContactPhone?`.
  - `EmployeePosition`: `id`, `departmentId`, `employeeId`, `positionId`, `priority?` (float, 0..10), `isLead` (boolean).
- API endpoints (legacy Express):
  - `GET /api/departments/:departmentId/employees`
  - `POST /api/departments/:departmentId/employees`
  - `PATCH /api/employees/:employeeId`
  - `DELETE /api/employees/:employeeId`
  - Position-related (optional for this phase, noted for parity):
    - `GET /api/departments/:departmentId/employeePositions`
    - `PUT /api/departments/:departmentId/employeePositions`
    - `POST /api/employeePositions`
    - `PATCH /api/employeePositions/:id`
    - `DELETE /api/employeePositions/:id`
  - Eligibility (optional follow-up): `GET /api/departments/:departmentId/eligible?requiredPositionId=...` (sorts by `EmployeePosition.priority` desc).
- Validation/normalization (legacy semantics to match):
  - Email format check; `state` must be 2-letter uppercase; `postalCode` exactly 5 digits; `postalCode4` exactly 4 digits; phones are digits-only, length 0 or â‰¥7.
  - Name composition: if `firstName`/`lastName` are updated and `name` not provided, recompute `name = "<first> <last>"` (trimmed) when non-empty.

### Data layer (Drizzle + migrations)
Create database tables and TS schemas to mirror legacy fields and constraints. Keep field names identical for easy client reuse.

- Create Drizzle SQL migrations:
  - `server/drizzle/0003_employees.sql` (new):
    - Table `employees`:
      - `id` text primary key (UUID string)
      - `department_id` text not null references `departments(id)` on delete cascade
      - `name` text not null
      - `priority` integer null
      - `first_name` text null
      - `middle_name` text null
      - `last_name` text null
      - `address1` text null
      - `address2` text null
      - `city` text null
      - `state` text null
      - `postal_code` text null
      - `postal_code4` text null
      - `primary_phone` text null
      - `email` text null
      - `emergency_contact_name` text null
      - `emergency_contact_phone` text null
      - `updated_at` timestamptz not null default now()
      - Index on (`department_id`)
  - Optional parity (if positions exist later): `server/drizzle/0004_employee_positions.sql` with `employee_positions` and foreign keys to `employees` and `positions`.

- Add Drizzle schema files:
  - `server/src/schema/employees.ts`: define `employees` table with the above columns (camelCase TS property names mapped to snake_case DB columns). Export types.
  - Optional follow-up: `server/src/schema/employeePositions.ts` if implementing positions integration now.
  - Update `server/src/schema/index.ts` to export `employees` (and `employeePositions` if added).

Notes:
- Use string IDs (UUID). Generate on insert in API layer (prefer `crypto.randomUUID()` with Node fallback) to match existing pattern in `events`/`departments` routes.

### API (Hono, protected under /api/v1)
Add routes with the same resource shapes as legacy while following current mount style (`/api/v1`). Apply `authMiddleware` as with `events` and `departments`.

- In `server/src/api.ts`:
  - Mount `employeesRoutes` under `/employees` and `/departments/:departmentId/employees` similar to existing route modules, or embed into a `departments` sub-router.
  - Routes to implement now:
    - `GET /api/v1/departments/:departmentId/employees`
      - Query all employees in department. Optionally accept `q` for case-insensitive name filter later.
      - Response: array of employees; may include computed `fullName` for convenience (`firstName + ' ' + lastName` or `name`).
    - `POST /api/v1/departments/:departmentId/employees`
      - Body: `name?`, `priority?`, full detail fields from legacy (`firstName`, `lastName`, `middleName`, address fields, phones, `email`, emergency contact fields).
      - Validations/normalizations to match legacy:
        - Normalize `state` to 2-letter uppercase (or null), `postalCode` to 5 digits, `postalCode4` to 4 digits, phone fields to digits-only; email regex check.
        - Require either non-empty `name` OR both `firstName` and `lastName`.
      - Compose `name` if not provided from `firstName`/`lastName`.
      - Insert, return record plus `fullName`.
    - `PATCH /api/v1/employees/:employeeId`
      - Partial update with the same validation and normalization rules. If `firstName` or `lastName` change and `name` omitted, recompute `name` from existing/new values.
      - Return record plus `fullName`.
    - `DELETE /api/v1/employees/:employeeId`
      - Delete employee; if/when `employee_positions` exists, also clear dependent rows in a transaction; if `assignments` later exist, null out `assigneeEmployeeId` first.

- Optional parity (defer unless positions are needed immediately):
  - `GET /api/v1/departments/:departmentId/employeePositions`
  - `PUT /api/v1/departments/:departmentId/employeePositions` (reset list for an employee)
  - `POST /api/v1/employeePositions`
  - `PATCH /api/v1/employeePositions/:id`
  - `DELETE /api/v1/employeePositions/:id`
  - `GET /api/v1/departments/:departmentId/eligible?requiredPositionId=...` (sort by `priority` desc)

Implementation details:
- Files to edit:
  - `server/src/api.ts`: wire routes, import `employees` schema, reuse `getDatabase`/`getDatabaseUrl` pattern.
  - `server/src/lib/db.ts`: no change.
  - `server/src/lib/env.ts`: no change.
  - `server/src/schema/index.ts`: export new tables.
  - Add small validators helper `server/src/lib/validators.ts` with functions equivalent to legacy (`isValidEmail`, `isValidState`, `isValidZip5`, `isValidZip4`, `isValidPhone`, `onlyDigits`).

### UI (React + Vite + Tailwind + ShadCN)
Add a minimal employees page that lists and edits records, mirroring core UX from legacy but styled with ShadCN components. Defer positions matrix UI until positions feature lands.

- New/updated files:
  - `ui/src/pages/Employees.tsx`: page with list + right-side drawer or dialog for create/edit.
    - List columns: Name, Email, Phone (digits), optional `priority`.
    - Search filter on client-side by name.
    - Create flow: require `firstName` or `lastName`. Normalize inputs before POST.
    - Edit flow: onBlur patch for key fields; recompute `name` in UI for display consistency.
  - `ui/src/lib/serverComm.ts`: add client functions:
    - `fetchEmployees(departmentId)`
    - `createEmployee(departmentId, body)`
    - `updateEmployee(employeeId, patch)`
    - `deleteEmployee(employeeId)`
  - `ui/src/App.tsx`: add route `"/departments/:departmentId/employees"`.
  - `ui/src/components/appSidebar.tsx`: add nav item to Employees under the selected department.

Auth/permissions:
- Protect employees routes server-side with `authMiddleware` like `events`/`departments`.
- UI: show create/delete actions based on existing role checks (reuse current auth context/guards in the app).

### Algorithms & behaviors to replicate (step-by-step)
1) POST create employee
   - Validate fields using helpers. If invalid, return 400 with message matching legacy semantics.
   - Normalize `state`, zip5/zip4, phone(s), trim strings.
   - If `name` falsy and `firstName`+`lastName` empty => 400.
   - Compute `name` from `firstName`/`lastName` if not provided.
   - Insert; return record plus `fullName` composed as in legacy.

2) PATCH update employee
   - For any provided field, validate and normalize that field only.
   - If phone provided and `emergencyContactPhone` set without `emergencyContactName` => 400 (legacy rule).
   - If `firstName` or `lastName` provided and `name` omitted, re-fetch current, recompute `name` and include in patch if non-empty.
   - Update; return record plus `fullName`.

3) GET list employees
   - Fetch by `departmentId`; return array (optionally include `fullName` for UI convenience).

4) DELETE employee
   - If dependent tables exist, clear in transaction, then delete.

### Phasing
- Phase 1 (Data layer):
  - Add migrations for `employees` (and optionally `employee_positions` if positions are ready).
  - Add `server/src/schema/employees.ts` and export it in `schema/index.ts`.

- Phase 2A (API):
  - Implement `GET/POST /departments/:departmentId/employees`, `PATCH/DELETE /employees/:employeeId` in `server/src/api.ts` with validation helpers.

- Phase 2B (UI):
  - Add `Employees.tsx` page, wire route and sidebar, and add client API calls in `serverComm.ts`.

- Phase 2C (Optional parity):
  - If positions land, add `employeePositions` routes and UI matrix, plus eligibility endpoint.

### Files to create/update (summary)
- Create:
  - `server/drizzle/0003_employees.sql`
  - `server/src/schema/employees.ts`
  - `server/src/lib/validators.ts`
  - `ui/src/pages/Employees.tsx`
- Update:
  - `server/src/schema/index.ts`
  - `server/src/api.ts` (mount employees routes)
  - `ui/src/lib/serverComm.ts` (employees client calls)
  - `ui/src/App.tsx` (route)
  - `ui/src/components/appSidebar.tsx` (nav)

### Environment/config
- No new environment variables required.
- Database URL resolution remains via existing `getDatabaseUrl()` logic; no changes.

### Out of scope (explicit)
- Positions and eligibility UIs and endpoints can be added in the follow-up phase once `positions` exists in current Drizzle schema.


