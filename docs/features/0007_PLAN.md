## Feature: Departments detail includes Positions (with employee mappings)

"I'd like to have the assignments/positions functionality that we have in @showcall_v1/ but instead of having a separate view for positions, it would be an area within the departments view's detail area."

### Context
- Current repo has `departments`, `employees`, and `events` (Drizzle). There is a `Departments` list-detail UI at `ui/src/pages/Departments.tsx` showing basic fields.
- v1 app includes:
  - Positions CRUD scoped to department: `AdminPositionsPage` (`src/web/src/views/AdminPositionsPage.tsx`) with API methods in `src/web/src/lib/apiClient.ts`.
  - Employee-Position join (`EmployeePosition`) with `priority` and `isLead`, used for eligibility and assignment flows.
  - Eligibility algorithm sorts employees by `EmployeePosition.priority` (desc) for a required position within the same department.

Goal: Embed positions management (and employee↔position mapping) inside the Departments detail panel, replacing the separate positions view.

### Data Layer (Drizzle + SQL Migrations)
- Create tables in public schema to align with `departments`/`employees`:
  - `positions` (id text PK, department_id text FK -> departments.id, name text not null, updated_at timestamptz default now())
  - `employee_positions` (id text PK, department_id text FK, employee_id text FK -> employees.id, position_id text FK -> positions.id, priority int null, is_lead boolean not null default false, updated_at timestamptz default now(), unique (department_id, employee_id, position_id))

- Add Drizzle schema files:
  - `server/src/schema/positions.ts` exporting `positions` and inferred types
  - `server/src/schema/employeePositions.ts` exporting `employeePositions` and inferred types
  - Update `server/src/schema/index.ts` to export `positions`, `employeePositions`

- Add SQL migrations:
  - `server/drizzle/0004_positions.sql`: CREATE TABLE public.positions ...
  - `server/drizzle/0005_employee_positions.sql`: CREATE TABLE public.employee_positions ... with unique constraint

### API (Hono)
- Extend `server/src/api.ts`:
  - Under departments routes:
    - GET `/api/v1/departments/:departmentId/positions` → list positions by department (filter by `q` optional)
    - POST `/api/v1/departments/:departmentId/positions` → create position `{ name }`
  - Item-level positions routes:
    - PATCH `/api/v1/positions/:positionId` → update `{ name }`
    - DELETE `/api/v1/positions/:positionId` → delete
  - EmployeePosition (join) routes:
    - GET `/api/v1/departments/:departmentId/employee-positions` → list join rows for dept
    - POST `/api/v1/employee-positions` → create `{ departmentId, employeeId, positionId, priority?, isLead? }`
    - PATCH `/api/v1/employee-positions/:id` → update `{ priority?, isLead? }`
    - DELETE `/api/v1/employee-positions/:id` → delete
  - Optional eligibility helper for future assignment UI parity (read-only):
    - GET `/api/v1/departments/:departmentId/positions/:positionId/eligible` → array of employees { id, name, priority } sorted desc by priority

### UI (React + shadcn) — Departments detail
- Update `ui/src/pages/Departments.tsx` right pane to add a new "Positions" section below the core fields:
  - Inline list of positions for the selected department with search (`q`) using the existing `FilterBar` pattern or a compact input.
  - Create inline controls (name input + Create/Cancel) reusing `CreateInline` and `Button`.
  - Inline rename/edit of a position; inline delete with confirm.
  - For each position row, expose a manage-mappings affordance:
    - Expand row or open a small drawer to show employees in the department with a checkbox per employee to add/remove mapping (backed by `employee_positions` endpoints), and small controls for `priority` (0–10 numeric input) and `isLead` (checkbox).
  - Keep the master-detail selection on the left list of departments unchanged.

- Add client API helpers in `ui/src/lib/serverComm.ts`:
  - Types: `PositionRecord`, `EmployeePositionRecord`
  - Positions: `listPositions(departmentId, { q? })`, `createPosition(departmentId, { name })`, `updatePosition(positionId, { name })`, `deletePosition(positionId)`
  - EmployeePositions: `listEmployeePositions(departmentId)`, `createEmployeePosition(payload)`, `updateEmployeePosition(id, patch)`, `deleteEmployeePosition(id)`

### Algorithms
- Eligibility (read-only endpoint and any client usage):
  1. Fetch `employee_positions` rows where `department_id = :departmentId AND position_id = :positionId`.
  2. Join to `employees` on `employee_id` to retrieve names and department consistency.
  3. Sort by `priority` descending (nulls treated as 0) and return `{ id, name, priority }`.

### Files to Create / Modify
- Create:
  - `server/src/schema/positions.ts`
  - `server/src/schema/employeePositions.ts`
  - `server/drizzle/0004_positions.sql`
  - `server/drizzle/0005_employee_positions.sql`
- Modify:
  - `server/src/schema/index.ts` (export new tables)
  - `server/src/api.ts` (new routes as above)
  - `ui/src/lib/serverComm.ts` (client helpers/types)
  - `ui/src/pages/Departments.tsx` (add positions section + mapping UI)

### Notes / Parity with v1
- Mirrors v1 positions CRUD and employee-position mapping found in `AdminPositionsPage` and `EmployeesPage` (mapping edit controls) but relocates it into the Departments detail area.
- Assignments UI lives under shifts/events in v1; this plan scopes to positions and mappings inside Departments. The eligibility endpoint provides the data needed when assignments UI is introduced later.

### Rollout
- DB: apply new SQL migrations (no .env changes). Ensure `server/scripts/apply-sql-migrations.mjs` runs or use existing workflow.
- API/UI: integrate incrementally; positions list should gracefully handle departments without positions.


