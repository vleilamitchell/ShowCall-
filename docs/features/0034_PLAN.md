### Event Template Editor — ListDetail under Events → Templates

Brief: Build an "event template editor" as a subsection under Events named "Templates", using the existing ListDetail feature. The list shows templates; the detail shows template details. Use the Events page as a reference for UX and data flows.

Key phrases from request: "event template editor", "subsection under events named 'Templates'", "using ListDetail feature", "Use the events page as a reference".

### Scope and Placement
- Place the editor at `Events → Templates` in the app navigation.
- Route: prefer `/events/templates` (keeping `/templates` supported/redirected if already in use).
- UX: mirror `ui/src/pages/Events.tsx` patterns (inline debounced patching, bootstrap where helpful, right-hand detail stacking panels).

### Files and Functions (create/edit)
- UI
  - Edit `ui/src/App.tsx`
    - Add/confirm route: `/events/templates` → `Templates` component.
    - Optionally keep `/templates` route for BC or redirect to `/events/templates`.
  - Edit `ui/src/components/appSidebar.tsx` (or `AppSidebar` export file)
    - Add "Templates" nav item under "Events" group, linking to `/events/templates`.
  - Create/confirm `ui/src/pages/Templates.tsx`
    - Implement ListDetail using `@/features/listDetail` (see `ui/src/pages/Events.tsx` for reference patterns like debounced patch, bootstrap, keying rerenders).
    - List: template rows (name + Active/Inactive status).
    - Detail: editable fields (name, description, active), version management (list, activate, create/clone), and requirements editor.
  - Reuse `ui/src/pages/Events.tsx` as reference for:
    - `ListDetailLayout`, `List`, `FilterBar`, `useListDetail`, `useDebouncedPatch` usage.
    - Right pane panel structure and keying to avoid stale state.

- API client
  - Edit `ui/src/lib/serverComm.ts`
    - Ensure these exist and are exported via `api`:
      - `listEventTemplates(params?: { q?: string; active?: boolean })`
      - `createEventTemplate(payload: { name: string; description?: string | null; titleTemplate: string })`
      - `getEventTemplate(templateId: string)`
      - `updateEventTemplate(templateId: string, patch: Partial<EventTemplate>)`
      - `listTemplateVersions(templateId: string)`
      - `createTemplateVersion(templateId: string, payload: { cloneFromVersionId?: string; titleTemplate?: string; notes?: string | null })`
      - `activateTemplateVersion(versionId: string)`
      - `getTemplateRequirements(versionId: string)`
      - `putTemplateRequirements(versionId: string, items: TemplateRequirementRow[])`
      - `applyTemplateToEvent(eventId: string, payload: { templateVersionId?: string; mode?: 'replace' | 'add'; shiftIds?: string[]; createAssignments?: boolean })`
    - Types used in UI: `EventTemplate`, `EventTemplateVersion`, `TemplateRequirementRow`, `Area`.

- Server
  - Edit `server/src/routes/index.ts`
    - Ensure `eventTemplatesRouter` is mounted under `/api/v1`.
  - Confirm `server/src/routes/eventTemplates.ts` provides:
    - `GET /event-templates`, `POST /event-templates`, `GET /event-templates/:templateId`, `PATCH /event-templates/:templateId`
    - `GET /event-templates/:templateId/versions`, `POST /event-templates/:templateId/versions`
    - `POST /event-template-versions/:versionId/activate`
    - `GET /event-template-versions/:versionId/requirements`, `PUT /event-template-versions/:versionId/requirements`
    - `POST /events/:eventId/apply-template`
  - Confirm `server/src/controllers/eventTemplatesController.ts` implements the above including version cloning + requirement cloning.
  - Confirm `server/src/controllers/templateApplicationController.ts` applies a template version to an event (shifts/assignments handling).
  - Confirm `server/src/schema/eventTemplates.ts` Drizzle schema exists and is used.

- Database (migrations)
  - Apply migrations for templates and associations (new tables + foreign keys):
    - `server/drizzle/0034_event_templates.sql`
    - `server/drizzle/0035_event_template_versions.sql`
    - `server/drizzle/0036_event_template_requirements.sql`
    - `server/drizzle/0037_events_add_template_refs.sql`
    - `server/drizzle/0038_assignments_add_template_source.sql`
    - `server/drizzle/0039_event_series_add_template_ref.sql`

### UI Behavior Details
- List (left pane)
  - Search by `q` against `name`/`description`.
  - Row shows template name and small Active/Inactive badge.
  - New Template button: creates `{ name: 'New Template', titleTemplate: 'Event' }` then selects it.

- Detail (right pane)
  - Header: editable `name` (debounced PATCH via `useDebouncedPatch`).
  - Basics: editable `description`, toggle `active`.
  - Versions panel:
    - Show all versions with indication of current.
    - Actions: Activate version; Create new version (optionally clone from current).
  - Requirements editor (for current version):
    - Rows: `requiredPositionId`, `count`.
    - Allowed Areas: checkbox chips for each active `Area` (from `listAreas({ active: true })`).
    - Add/Remove rows; Save writes full set via `putTemplateRequirements`.

### Algorithms and Flows
- Create Template
  1) POST `/event-templates` with `name`, `titleTemplate`.
  2) Server also creates Version 1 with `titleTemplate` and `isCurrent=true`.
  3) UI selects new template and fetches versions + requirements.

- Create Version
  1) POST `/event-templates/:templateId/versions` with optional `cloneFromVersionId`.
  2) Server finds next `versionNumber` and inserts; if `cloneFromVersionId` or current exists, clone requirements and allowed area links.
  3) UI refreshes versions list.

- Activate Version
  1) POST `/event-template-versions/:versionId/activate`.
  2) Server flips `isCurrent` for all versions of template, sets active on target.
  3) UI updates indicators and reloads requirements for current.

- Requirements Save
  1) UI sends full array to `PUT /event-template-versions/:versionId/requirements`.
  2) Server replaces existing rows and area links for the version.
  3) UI refetches requirements to confirm persisted state.

- Apply Template to Event (used from Events detail; helpful for validation)
  1) UI calls `POST /events/:eventId/apply-template` with optional `templateVersionId` and `mode`.
  2) Server expands current or specified version’s requirements into shifts/assignments per business rules.
  3) UI reboots the event detail via `bootstrapEventDetail` to refresh areas and shifts.

### Tests (define before implementing)
- Server API
  - list/create/get/patch template endpoints: 200/201/404, validation on required fields.
  - versions: create (with and without clone), list ordered, activate toggles flags correctly.
  - requirements: get/put roundtrip integrity; PUT replaces; FK constraints errors surface.
  - apply-to-event: dry-run happy path using a small fixture; ensures assignments created or replaced per mode.

- Database
  - Migration ordering runs cleanly on a fresh DB; FKs: `required_position_id` references positions; area junction PK composite.

- UI (component/integration)
  - Templates List renders items, searching by `q` filters results.
  - Detail edits debounce and persist `name` and `description`.
  - New Version button creates and updates versions list; Activate toggles.
  - Requirements editor: add/remove rows; toggle allowed areas; Save and reload reflects persisted state.
  - Navigation: clicking sidebar "Templates" under "Events" routes to `/events/templates`.

### Phases
- Phase 1 — Data Layer
  - Run migrations 0034–0039; verify schema aligns with `server/src/schema/eventTemplates.ts`.

- Phase 2A — Server API
  - Wire routes in `server/src/routes/eventTemplates.ts`; implement controllers in `server/src/controllers/eventTemplatesController.ts` and `server/src/controllers/templateApplicationController.ts`.
  - Mount in `server/src/routes/index.ts`.

- Phase 2B — UI
  - Add sidebar nav and route; implement `ui/src/pages/Templates.tsx` using ListDetail.
  - Reuse `ui/src/pages/Events.tsx` patterns (debounced patch, bootstrap refresh) where applicable.

- Phase 3 — QA and Polish
  - Validate apply-to-event flow from Events detail page.
  - Empty states, loading skeletons, and error toasts consistent with Events page.


