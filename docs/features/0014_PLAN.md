### Production Inventory UI — Technical Plan

Brief context (from request):
- The Production department manages cables, rigging equipment, computers, lighting, etc. Not everything is serialized; high-cost equipment is serialized and requires issue/repair/maintenance logs.
- The inventory screen should present a Production-specific experience on top of the unified inventory core and ledger in `@0013_PLAN.md`.

---

### Scope

- Build a Production-focused UI within the existing Inventory section: list, detail, activity, reservations, and asset workflows (checkout/checkin, transfer, count adjust, maintenance start/end). Minimize schema changes by leveraging the existing ledger `event_type`s and `source_doc` to carry log metadata.
- Add small backend helpers to read transactions/activity and on-hand summaries to support the UI.

---

### UI Routes and Navigation

- Add Production routes under `/inventory`:
  - `/inventory/production` — Production dashboard (summary KPIs + quick actions)
  - `/inventory/production/items` — items list (Production filters)
  - `/inventory/production/items/:itemId` — item detail (overview, serials, activity, reservations, maintenance)
  - `/inventory/production/transactions/new` — transaction wizard (checkout/checkin/transfer/count adjust)

Files (UI):
- Update `ui/src/App.tsx` to add the routes above.
- Keep `ui/src/pages/Inventory.tsx` as the generic landing; link to Production page.
- New components under `ui/src/features/inventory/production/`:
  - `ProductionInventoryPage.tsx` — dashboard shell (KPI cards: On-hand, Available, Recent Activity)
  - `ProductionItemsTable.tsx` — searchable/filterable items table
  - `ProductionItemDetail.tsx` — item header + tabs
    - `OverviewTab.tsx` — on-hand by location, attributes summary
    - `SerialsTab.tsx` — serialized assets list (placeholder until serials API is ready; hide for non-serialized)
    - `ActivityTab.tsx` — transactions timeline for the item
    - `ReservationsTab.tsx` — list/create/release reservations
    - `MaintenanceTab.tsx` — start/end maintenance, log issue/repair notes
  - `CheckoutWizard.tsx` — checkout/checkin flow (supports serial or quantity)
  - `TransferDialog.tsx` — location-to-location transfer
  - `CountAdjustDialog.tsx` — cycle count adjust (computes delta)

Component notes:
- Use ShadCN primitives already in the project (tables, dialogs, tabs). Add components via `npx shadcn add` if needed.
- Keep state with local React state + async calls in `serverComm` (no new global state lib).

---

### UX/Flows (Production)

1) Items list
   - Columns: SKU, Name, Type, Serialized?, On-hand (sum), Available (sum − reservations), Locations (count), Active
   - Filters: `q`, `item_type` in {ReturnableAsset, FixedAsset, Rental, Kit, Consumable (rare)}, Active/Inactive
   - Row actions: View, Checkout, Transfer, Count Adjust

2) Item detail
   - Header: name, SKU, type, base unit, active status, quick actions
   - Overview: table of on-hand by location (and lot if present), attributes (schema-bound) summary
   - Serials: for serialized items (high-cost assets) — list serials, status (available/reserved/out, in maintenance), last activity; if serials not yet implemented, show placeholder and note
   - Activity: transactions timeline (filters: date range, event types)
   - Reservations: list existing; create (event-linked); release/fulfill
   - Maintenance: Start (MAINTENANCE_START), End (MAINTENANCE_END); capture notes/reason in `source_doc`; show open maintenance status badge

3) Transactions
   - Checkout (MOVE_OUT):
     - Serialized: pick serials (multi-select); non-serialized: quantity
     - Optional reservation validation (soft warning until policy layer is enforced)
   - Checkin (MOVE_IN): select serials or quantity
   - Transfer: post `TRANSFER_OUT` from source and `TRANSFER_IN` to destination (paired via shared `source_doc`)
   - Count Adjust: fetch current on-hand, enter counted qty, compute delta = counted − on_hand, post `COUNT_ADJUST` with delta

4) Maintenance / Issue/Repair
   - Start maintenance: post `MAINTENANCE_START` event with `source_doc` { reason, notes[, technician] }
   - End maintenance: post `MAINTENANCE_END` with `source_doc` { resolution, notes[, parts] }
   - Display these in the Maintenance tab and Activity timeline

---

### Backend/API Additions (minimal to support UI)

Endpoints (protected under `/api/v1/inventory`):
- `GET /transactions` — list transactions
  - Query params: `itemId?`, `locationId?`, `eventType?` (comma-separated), `from?` (ISO), `to?` (ISO), `limit?` (default 100), `order?` (desc|asc)
  - Service: `server/src/services/inventory/transactions.ts#listTransactions`
- `GET /items/:itemId/summary` — on-hand by location and simple availability
  - Response: `{ onHand: Array<{ locationId, name, lotId?, qtyBase }>, totals: { onHand, reserved, available } }`
  - Service: `server/src/services/inventory/projections.ts#getItemSummary`
- (Optional, future) `GET /items/:itemId/serials` — list serials and status when serials table lands

Existing endpoints to use:
- `POST /transactions` (already mounted) for checkout/checkin/transfer/count adjust/maintenance
- `GET /items`, `GET /items/:itemId`, `PATCH /items/:itemId`
- `GET /reservations`, `POST /reservations`, `PATCH /reservations/:resId`
- `GET /locations`

Files (server):
- `server/src/api.ts` — add the new `GET /inventory/transactions` and `GET /inventory/items/:itemId/summary` routes
- `server/src/services/inventory/transactions.ts` — new: `listTransactions(filters)`
- `server/src/services/inventory/projections.ts` — add `getItemSummary(itemId)` that aggregates `inventory_txn` and active reservations

Notes:
- For availability: `available = onHand − sum(reservations in HELD within [now, future])` (simplified until full windowing is needed)
- Use existing `event_type` enums: `MOVE_OUT/MOVE_IN`, `TRANSFER_OUT/TRANSFER_IN`, `COUNT_ADJUST`, `MAINTENANCE_START/END`, `RECEIPT`, `WASTE`

---

### API Client Additions (`ui/src/lib/serverComm.ts`)

- `listInventoryTransactions(params?: { itemId?: string; locationId?: string; eventType?: string | string[]; from?: string; to?: string; limit?: number; order?: 'asc'|'desc' })`
- `getInventoryItemSummary(itemId: string)`

Reuse existing helpers:
- `listInventoryItems`, `getInventoryItem`, `patchInventoryItem`, `postInventoryTransaction`, `listReservations`, `createReservation`, `updateReservation`, `listInventoryLocations`

---

### Data/State contracts in UI

- On-hand summary drive: Overview tab table and KPI totals
- Transactions drive: Activity tab (paginate or cap to latest N with a “Load more”)
- Maintenance actions: call `postInventoryTransaction` with `eventType` and embed log metadata in `sourceDoc`
- Reservations: use existing endpoints; tie to events/work orders via `eventId`

---

### Files and Change Map

UI:
- Update `ui/src/App.tsx` routes
- New `ui/src/pages/InventoryProduction.tsx`
- New `ui/src/features/inventory/production/*` components listed above
- Extend `ui/src/lib/serverComm.ts` with `listInventoryTransactions`, `getInventoryItemSummary`

Server:
- Update `server/src/api.ts` to add `GET /api/v1/inventory/transactions` and `GET /api/v1/inventory/items/:itemId/summary`
- New `server/src/services/inventory/transactions.ts`
- Update `server/src/services/inventory/projections.ts` with `getItemSummary`

Environment:
- No new env required beyond existing `DATABASE_URL` and `VITE_API_URL`

---

### Implementation Notes

- Start with list/detail and summary endpoints; wire transactions list next; add dialogs last.
- If serials backend isn’t ready, hide Serials tab for non-serialized items and show a placeholder for serialized items.
- Use append-only posting and never mutate transactions; reversals are new entries.


