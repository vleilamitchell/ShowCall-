## Contacts View UX updates (+ organization field)

Context: Apply the following changes to the Contacts experience, per request: "Remove the rollout under the new button, rename the new button to + New, move new button to top right of content form, on click, use form for new creation, save/cancel at top, remove delete button on form and put on a kebab menu in the list, change list text to computed name, add organization to the contact." Be thorough with this design.

### Scope
- UI adjustments in `ui/src/pages/Contacts.tsx` using existing `ListDetailLayout` and `List` components.
- Minor UX hook-up via `List` `renderActions` for a per-row kebab menu.
- Add `organization` to the `contacts` model (DB schema, API, client types, and UI form/search/labels).

---

## Data Layer (Drizzle + API + Client Types)

### DB Schema
- File: `server/src/schema/contacts.ts`
  - Add nullable `organization` column: `text('organization')`.
  - Exported types (`Contact`, `NewContact`) derive the field automatically.

- Migration: add new SQL file: `server/drizzle/<timestamp>_add_organization_to_contacts.sql`
  - `ALTER TABLE contacts ADD COLUMN organization text;`
  - Optional index (if desired for filtering later): `CREATE INDEX IF NOT EXISTS idx_contacts_org ON contacts (organization);`

### API (Hono)
- File: `server/src/api.ts` (contacts routes)
  - Ensure `organization` is accepted on `POST /api/v1/contacts` and `PATCH /api/v1/contacts/:contactId`.
  - Normalize empty strings to `null` for `organization` (same as other nullable fields).
  - Return `organization` in response bodies for all GET/POST/PATCH routes.
  - No change to ordering (still order by `lastName`, `firstName`).

### Client Types and API Client
- File: `ui/src/lib/serverComm.ts`
  - Extend `ContactRecord` with: `organization?: string | null`.
  - Ensure `listContact`, `createContact`, `getContact`, `updateContact`, `deleteContact` continue to serialize/deserialize `organization` (no new endpoints required).

---

## UI/UX Changes (Contacts page)

### Files
- `ui/src/pages/Contacts.tsx`
- `ui/src/features/listDetail/components/List.tsx` (no core changes; use `renderActions` API)
- If shadcn dropdown menu components are not present: add `DropdownMenu` via `npx shadcn add dropdown-menu` and an icon button (e.g., `Button` + icon) for the kebab.

### Remove inline rollout under the list "New" button
- Today: the left/list pane header renders a `New` button that toggles `creating` and shows an inline create form under it.
- Change: remove the inline form entirely from the left pane; delete the state/UI wiring in the left header that shows the multi-input block under the button.

### Rename and relocate the New button
- Rename to "+ New".
- Move to the top-right of the right/detail pane (the "content form").
  - Add a small header bar at the top of the detail pane (above the fields) with layout: left = context text (e.g., selected name or "New Contact"), right = `+ New` button.

### Creation flow: use the main form, with Save/Cancel at top
- On `+ New` click:
  - Enter a "create mode" that shows an empty contact in the right pane form (same fields as edit, including `organization`).
  - Show `Save` and `Cancel` at the top of the right pane header (to the left of or replacing `+ New` while in create mode). Keep them visible/sticky as the user scrolls.
  - `Save`: submit to `createContact` with normalized values (trimmed strings, empty to `null`). On success, select the newly-created contact (exit create mode).
  - `Cancel`: exit create mode and restore the previously selected contact (if any).
- Editing existing contacts continues to use the current debounced patch-on-blur behavior; do not add Save/Cancel for edit mode.

### Remove Delete button from the form
- Today: a `Delete` button is rendered at the bottom of the right/detail pane.
- Change: remove the `Delete` button from the form entirely.

### Move Delete to a kebab menu in the list
- Use `List` `renderActions` to render a per-row kebab menu aligned right.
- Kebab menu contents: `Delete`.
  - On click, call `deleteContact(item.id)` (or the `remove` action from the resource hook) and update the list selection properly (e.g., select next or none).
  - Optional: confirmation dialog prior to delete.
- Implementation detail:
  - If not yet present, add shadcn `DropdownMenu` components and render a small ghost icon button (three-dots vertical) as the trigger.

### Change list text to computed name
- Maintain a `computedName` function for each contact list row label:
  1) If `lastName` or `firstName` present: "{lastName}, {firstName}" with missing parts omitted and comma formatting preserved.
  2) Else if `email` present: `email`.
  3) Else if `contactNumber` present: `contactNumber`.
  4) Else fallback to `id`.
- Optional enhancement: if `organization` is present, show a secondary line like `organization` beneath the primary label in muted text.

### Add organization to the form
- Insert a new input for `organization` in the right/detail pane fields (group with name fields or contact details section).
- Ensure changes are wired to `mutateItems` and `onPatchChange` for edit mode, and to the create payload for create mode.
- Add `organization` to searchable fields array used by the adapter (list filtering).

---

## Implementation Notes (by file)

### `ui/src/pages/Contacts.tsx`
- Remove left-pane `creating` UI and associated inputs. Keep search input if desired (current implementation supports simple local filtering).
- Add right-pane header bar:
  - Normal mode: right-aligned `+ New` button.
  - Create mode: left-aligned `Save` and `Cancel` buttons (and a title like "New Contact"). Hide/disable `+ New` during create mode.
- Create mode wiring:
  - Reuse existing `creating`, `form`, `submitting`, `createError` state; scope its UI to the right pane.
  - `Save` calls `create(form)` or `createContact(form)` and on success: select returned `id`, clear `form`, exit create mode.
  - `Cancel` clears `form`, exits create mode, and restores the previously selected contact.
- Edit mode wiring (unchanged): use `useDebouncedPatch` and `onBlurFlush` for field changes.
- Remove bottom `Delete` button.
- Add `renderActions` to the `List` to expose a kebab menu with `Delete`.
- Update `contactLabel` (or rename to `computedName`) to follow the algorithm above; optionally render `organization` as secondary muted text.
- Fields: add an input for `organization` in the proper section.

### `ui/src/lib/serverComm.ts`
- Extend `ContactRecord` to include `organization?: string | null`.
- No change to endpoint URLs; ensure payloads include `organization` when present.

### `server/src/schema/contacts.ts`
- Add `organization` field to the Drizzle schema.

### `server/drizzle/<timestamp>_add_organization_to_contacts.sql`
- Add the column as described above.

### `server/src/api.ts`
- Ensure contact endpoints pass through `organization` for POST and PATCH and include it in response bodies.
- Maintain normalization (trim strings, empty to `null`).

### `ui/src/features/listDetail/components/List.tsx`
- No functional change required; use existing `renderActions` prop for the kebab.

---

## Algorithms & Behaviors

### Computed Name
- Input: `firstName`, `lastName`, `email`, `contactNumber`, `id`.
- Steps:
  1) Construct parts `[lastName, firstName]`, filter empty/whitespace-only; join with `, `.
  2) If result non-empty, return it.
  3) Else if `email` non-empty, return `email`.
  4) Else if `contactNumber` non-empty, return `contactNumber`.
  5) Else return `id` or `'(unnamed)'` if `id` is unexpectedly empty.
- Display: primary line shows computed name; secondary line (muted) may show `organization` if present, otherwise email/phone.

### Create Mode Save/Cancel
- Enter create mode: set `creating = true`, store `prevSelectedId = selectedId`, and render an empty form in the right pane.
- Save: validate minimal client-side rules (optional), call `createContact(form)`, then `select(created.id)`, `creating = false`.
- Cancel: `creating = false`, `select(prevSelectedId)`; discard draft form state.

### Delete via Kebab
- Triggered from list row kebab menu.
- Optional confirm dialog; on confirm call `deleteContact(id)`.
- Update UI list: remove the item; if it was selected, clear selection or select an adjacent item.

---

## Phases

### Phase 1 — Data Layer
1) Add `organization` to Drizzle schema (`server/src/schema/contacts.ts`).
2) Create and run migration to add `organization` column.
3) Update contacts routes in `server/src/api.ts` to include `organization` in POST/PATCH/GET responses and normalize inputs.
4) Update `ContactRecord` in `ui/src/lib/serverComm.ts`.

### Phase 2 — UI/UX
1) `ui/src/pages/Contacts.tsx`:
   - Remove inline rollout create UI in left pane.
   - Add right-pane header with `+ New`. Wire create mode to show form on the right.
   - Add `Save`/`Cancel` buttons at the top only during create mode.
   - Remove form `Delete` button.
   - Add kebab menu to list rows using `renderActions` with a `Delete` item.
   - Add `organization` field to the form and to search fields.
   - Ensure computed name label logic is applied to list items.
2) Ensure dropdown menu component exists (if not, `pnpm add` any required icon lib and `npx shadcn add dropdown-menu`).

---

## Acceptance Notes (technical)
- New contact creation is performed in the detail form on the right, with Save/Cancel at the top.
- The left pane no longer shows an inline create form under the New button; the button is moved and renamed to `+ New` in the right pane.
- Delete is accessible only via the list row kebab menu; the form has no delete button.
- List labels show computed name as defined; `organization` displays as secondary text when available.
- `organization` is stored and returned through API and appears in the UI form and list.


