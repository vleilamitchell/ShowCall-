## Feature: Associate Events with AREAS and manage Areas

"Design an addition to the events which associates an event with AREAS. Areas are parts of the venue which serve as independant operational areas. An event can use one or many of the areas. We will also need a way to add new areas to the application."

### Context
- Current events model is in `server/src/schema/events.ts` and the REST endpoints are in `server/src/api.ts` (`/events` CRUD). UI for Events lives in `ui/src/pages/Events.tsx` and uses a panel-based detail layout with feature panels such as `EventShiftsPanel` and `EventMarketingPanel`.
- We need a global catalogue of Areas (venue operational areas), and a many-to-many association between `Event` and `Area`. Users must be able to:
  - Attach one or many Areas to an Event in the Event detail UI.
  - Create new Areas (inline in the Event UI and via a dedicated Areas management view).

### Data Layer (Postgres + Drizzle)
Add two tables and Drizzle schema models. IDs remain text-based, consistent with existing tables.

1) `areas` table
- Columns: `id text PK`, `name text not null unique`, `description text null`, `color text null` (CSS hex or token), `active boolean not null default true`, `updated_at timestamptz not null default now()`
- Index: unique on `name`, index on `active`.

2) `event_areas` join table
- Columns: `event_id text not null FK -> events.id on delete cascade`, `area_id text not null FK -> areas.id on delete restrict`, `added_at timestamptz default now()`
- Primary key: composite `(event_id, area_id)`
- Indexes: by `event_id`, by `area_id`.

Implementation details:
- Create SQL migration: `server/drizzle/0021_areas.sql` to CREATE TABLEs with the constraints and indexes described above.
- Add Drizzle schema files:
  - `server/src/schema/areas.ts`: exports `areas` and inferred types `Area`, `NewArea`.
  - `server/src/schema/eventAreas.ts`: exports `eventAreas` (composite PK) and inferred type.
  - Update `server/src/schema/index.ts` to export the new tables.

Notes:
- Keep `on delete cascade` from `events` to `event_areas` so event deletion automatically clears associations.
- Use `on delete restrict` from `areas` to `event_areas` so an Area cannot be deleted if referenced; the API should convert this to a 409 user-facing error with guidance.

### Server API (Hono)
Augment `server/src/api.ts` with new routes and minimal changes to existing ones. Follow existing patterns for auth, DB acquisition, and error handling. Use the same `randomUUID` generation approach for new `Area` IDs.

1) Areas CRUD
- Base: `/areas` (secured with `authMiddleware` like other routes)
  - `GET /areas`: list with filters `?q=`, `?active=true|false` (optional). Text search over `name`.
  - `POST /areas`: create area `{ name, description?, color?, active? }`. Validate `name` (trimmed, non-empty, <= 120 chars). Enforce unique `name`.
  - `PATCH /areas/:areaId`: partial update for `{ name?, description?, color?, active? }`. Re-validate fields; unique `name` on change.
  - `DELETE /areas/:areaId`: attempt to delete; return 409 with `{ error: 'AreaInUse' }` if FK restrict hits due to existing `event_areas` rows.

2) Event↔Areas association
- Nested under events: `/events/:eventId/areas`
  - `GET /events/:eventId/areas`: list Areas attached to the event (join `event_areas`→`areas`).
  - `PUT /events/:eventId/areas`: replace associations atomically with `{ areaIds: string[] }`.
    - Algorithm: fetch current `area_id`s for event; compute set difference; in a transaction, delete removed pairs and insert new pairs; return the full updated list of Areas.
  - `POST /events/:eventId/areas`: add one `{ areaId }`; idempotent (ignore if exists) or 409 on duplicate; return updated list.
  - `DELETE /events/:eventId/areas/:areaId`: remove one; return 204 or updated list.

3) Event read augmentation (optional)
- Option A (safer, fewer ripple effects): keep `/events/:eventId` returning the event only; clients fetch `/events/:id/areas` separately in panels.
- Option B (richer): extend `/events/:eventId` and list endpoints to include an `areas: Area[]` field via joins. If chosen, update UI types and client mapping accordingly.

Validation utilities
- Add simple validators in `server/src/lib/validators.ts`:
  - `isValidColor(text | null)`: allow `#rrggbb`, `#rgb`, or empty.
  - `validateAreaName(name)`: non-empty, trimmed, length bound.
Use them in Areas create/patch routes.

### UI/UX
Embrace current list-detail pattern and ShadCN components.

1) Event detail panel: Areas
- Create `ui/src/features/events/EventAreasPanel.tsx` analogous to `EventMarketingPanel`.
- Behavior:
  - Shows selected Areas as chips/badges; supports remove via chip X.
  - “Add area” combobox with search-as-you-type over all Areas; shows an inline “Create "+ <query>” action when no exact match; creating immediately adds to global Areas and associates to the event.
  - Debounced syncing: on add/remove, call the event areas endpoints. For batch-edits, use the `PUT /events/:id/areas` replace endpoint.
  - Empty state copy: explain that “Areas are parts of the venue which serve as independant operational areas.” and that an event can use multiple.
  - Keyboard and a11y: support Enter to add, Esc to cancel, focus ring, and visible labels.
- Visuals:
  - Use ShadCN `Badge`, `Command`, `DropdownMenu`, or `ComboBox` patterns already present in the codebase.
  - Optional color chips using `area.color` as a left swatch.

2) Areas management view
- Create `ui/src/pages/Areas.tsx` as a simple list-detail admin page (similar to `Departments.tsx` basics):
  - List all Areas with quick filters (Active/All), search by name, and inline toggle for active state.
  - Detail pane for editing `name`, `description`, `color`, `active`.
  - Prevent delete if in use; surface a toast explaining references by events.
- Add navigation entry in the sidebar under Settings or a top-level “Areas” if preferred. Update `ui/src/App.tsx` routes and `AppSidebar` to include it.

3) Events list and calendar niceties (optional, Phase 3)
- In `ui/src/pages/Events.tsx` list rows, add small area badges inline (truncate + tooltip).
- Add a filter in `FilterBar` to filter events by Area (multi-select). Server-side: accept `?areaId=` (repeatable) on list endpoint or filter client-side if list is small.
- In `ui/src/pages/EventsCalendar.tsx`, optionally colorize events by their first Area’s color swatch.

Client data layer
- Update `ui/src/lib/serverComm.ts`:
  - Types: add `Area` type; export API helpers `listAreas`, `createArea`, `updateArea`, `deleteArea`, `getEventAreas`, `replaceEventAreas`, `addEventArea`, `removeEventArea`.
  - If augmenting event payloads (Option B), update `EventRecord` to include `areas?: Area[]` and wire up mapping.

### Files to Create / Update
Data & Server
- New: `server/drizzle/0021_areas.sql`
- New: `server/src/schema/areas.ts`, `server/src/schema/eventAreas.ts`
- Update: `server/src/schema/index.ts`
- Update: `server/src/lib/validators.ts` (add color/name validators)
- Update: `server/src/api.ts` (mount `/areas` routes; add `/events/:eventId/areas` nested routes; optionally extend event read)

UI
- New: `ui/src/features/events/EventAreasPanel.tsx`
- Update: `ui/src/pages/Events.tsx` (import and render `EventAreasPanel` in the detail stack)
- New: `ui/src/pages/Areas.tsx`
- Update: `ui/src/App.tsx` (add route) and `ui/src/components/AppSidebar.tsx` (or equivalent) to expose navigation
- Update: `ui/src/lib/serverComm.ts` (new client functions, updated types)

### Step-by-step Algorithms
1) Replace event areas transaction (PUT `/events/:id/areas`)
- Input: `areaIds` (array of strings)
- Steps:
  1. Normalize unique set of `areaIds` after trimming; validate all exist.
  2. Query current `event_areas` for the event → `currentIds`.
  3. Compute `toAdd = areaIds − currentIds`, `toRemove = currentIds − areaIds`.
  4. In a transaction: bulk delete rows for `toRemove`; bulk insert rows for `toAdd`.
  5. Return joined full `Area[]` for the event.

2) Inline create-and-associate flow from UI combobox
- If user chooses “Create "+ query”:
  1. `POST /areas { name: query }` → returns `area`.
  2. `POST /events/:id/areas { areaId: area.id }` → returns updated list.
  3. Optimistically reflect in UI; on failure, revert and show message.

3) Prevent area deletion when in use
- Attempt `DELETE /areas/:id`.
- On FK violation, translate to `409 AreaInUse` with message including a count of referencing events (optional: `SELECT COUNT(*) FROM event_areas WHERE area_id = $1`).

### Non-goals and Constraints
- Areas are global to the venue and not scoped to departments.
- Do not couple Areas to Inventory `locations` at this stage; can be considered later.
- Keep API surface minimal; avoid embedding areas into event payloads unless Option B is explicitly chosen.

### Phases
Phase 1 — Data layer
- Migration `0021_areas.sql`, Drizzle schemas, schema index export.

Phase 2 — Server API
- Areas CRUD routes and event-areas nested routes; validators; 409 on in-use delete.

Phase 3 — UI
- EventAreasPanel added to Events detail; serverComm helpers; inline create.
- Areas management page and navigation.

Phase 4 — Enhancements (optional)
- Events list area badges and filters; calendar color accents.

### Environment and Ops
- No new env vars required.
- If you run migrations locally, ensure the embedded Postgres is up (see `database-server/` and scripts). Apply the new migration after pulling.


