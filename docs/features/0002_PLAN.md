## Feature: Events (porting the v1 implementation into the new stack)

### Context
- The instruction is: “@showcall_v1/ uses events. Let's take the idea of events from their implementation.”
- In `showcall_v1`, events are a cross-department container with fields: title, promoter, status, date, startTime, endTime, description, artists. UI supports listing, search, past-event filtering, creating events, and viewing an event’s shifts. API supports GET/POST/PATCH and event-scoped shifts.
- This plan ports the above behavior to the current project’s tech stack: Hono API, Drizzle ORM (PostgreSQL), Firebase Auth, React (Vite), Tailwind, ShadCN.

### Scope
- Data: Introduce `events` table (Drizzle) similar to v1 schema; prepare for optional linkage from `shifts` later.
- API: Add Hono routes under `/api/v1/events` for list, create, read, update, and `/api/v1/events/:eventId/shifts` (list) with the same query semantics as v1.
- UI: Add an Events page with list + detail pane and “Show past events” toggle; add create event flow; add navigation entry.
- Auth: Require authentication (Firebase) for all endpoints; authoring (POST/PATCH) should be behind the protected routes middleware; later we can refine to role-based.

### Data model (Drizzle + PostgreSQL)
- Create `server/src/schema/events.ts` defining table `events` with columns:
  - id (cuid/uuid text primary key)
  - title (text, required)
  - promoter (text, nullable)
  - status (text, required; values e.g. planned | confirmed | canceled; store as text for now)
  - date (text, required; YYYY-MM-DD)
  - startTime (text, required; HH:mm)
  - endTime (text, required; HH:mm)
  - description (text, nullable)
  - artists (text, nullable; comma-separated)
  - updatedAt (timestamp with time zone, default now)
- Indexes:
  - `events_date_start_end_idx` on (date, startTime, endTime) for sorting/filtering
  - `events_status_idx` on (status)
  - Optional GIN/BTREE indexes for title/promoter/artists search (case-insensitive LIKE). Start with BTREE on title/promoter; expand later if needed.
- Relationship prep (future): `shifts.eventId` (nullable fk) to support "event-scoped shifts"; do not block this feature if `shifts` is not yet implemented.
- Migration:
  - Add a new Drizzle SQL migration under `server/drizzle/0001_events.sql` (next sequential number) to create the `events` table and indexes.
  - Wire `events` schema into `server/src/lib/db.ts` by including the new schema export in the Drizzle schema bundle.

### API (Hono)
- Location: extend `server/src/api.ts` under the existing `/api/v1` router. Use the protected router for all event routes.
- Routes and semantics (mirror v1 behavior):
  - GET `/api/v1/events`
    - Query params:
      - `status?: string`
      - `q?: string` (search in title/promoter/artists, case-insensitive contains)
      - `includePast?: 'true' | 'false'` (default false)
    - Filtering logic (time-window behavior):
      - Compute currentDate = today (YYYY-MM-DD), currentTime = now (HH:mm).
      - If `includePast` is false, only include events where either:
        - date == currentDate AND endTime >= currentTime, or
        - date > currentDate.
      - Combine with `status` and `q` constraints (AND with the above time window; OR across the q searchable fields).
    - Sort: `ORDER BY date DESC, startTime DESC`.
  - POST `/api/v1/events`
    - Body: `{ title (required), promoter?, status?='planned', date?=today, startTime?='00:00', endTime?='23:59', description?, artists? }`.
    - Returns created event.
  - GET `/api/v1/events/:eventId`
    - Returns event by id or 404.
  - PATCH `/api/v1/events/:eventId`
    - Body: partial update across all fields; server updates `updatedAt` to now.
    - Returns updated event.
  - GET `/api/v1/events/:eventId/shifts`
    - Query params: `departmentId?` (optional filter)
    - Returns shifts linked to `eventId` (if/when shifts exist). Return empty array if shifts not implemented yet.
- Validation:
  - Enforce `title` non-empty on POST.
  - Normalize strings; coerce optional fields to null when empty.
  - Basic bounds for `date` and `time` format (string-level format checks); deeper validation can be added later.
- Auth:
  - Mount under protected routes (existing `authMiddleware`).
  - POST/PATCH should require authenticated user; GET can remain authenticated for now.

### UI (React + Tailwind + ShadCN)
- Add page `ui/src/pages/Events.tsx` implementing master/detail layout:
  - Left list: events with columns Date and Name. Supports `q` search box and a “Show past events” checkbox that toggles the `includePast` query param.
  - Right detail: when an event is selected, show an `EventDetail`-style panel with editable title (updates list title when changed), read-only display of promoter/status/dates/times/artists/description for now. If authoring allowed, show inline edit controls later.
  - A “New Event” button (visible when user can author) opens an inline create panel with fields: title (required), status, date, startTime, endTime, promoter, artists, description. On submit, call POST, prepend to list, select newly created event.
- Navigation:
  - Add an “Events” item in `ui/src/components/appSidebar.tsx` that routes to `/events`.
  - Add route in `ui/src/App.tsx` to render `Events` at `/events`.
- API client:
  - Extend `ui/src/lib/serverComm.ts` with helpers:
    - `listEvents({ q?, status?, includePast? })`
    - `createEvent(payload)`
    - `getEvent(eventId)`
    - `updateEvent(eventId, patch)`
    - `listEventShifts(eventId, { departmentId? })` (no-op until shifts exist)
  - All calls use existing `fetchWithAuth` and Firebase id token.
- State/behavior:
  - Match v1 behavior for route-driven selection. Initial simple route can be `/events` (list-only) and `/events/:eventId` (select by id).
  - Implement optimistic list update after create.

### Mapping from v1 → new stack
- v1 Prisma model `Event` → Drizzle table `events` with equivalent fields and indexes.
- v1 Express routes `/api/events` → Hono routes under `/api/v1/events` with identical query semantics (status/q/includePast and time-window filtering).
- v1 `EventsPage.tsx` patterns → new `Events.tsx` reproducing listing, show-past toggle, create flow, and selection.
- v1 event-scoped shifts endpoint → keep route parity; return empty list until shifts are introduced in the new schema.

### Phasing
1) Data layer
   - Define `events` table and migration.
   - Export schema from `server/src/schema/events.ts` and include in Drizzle schema wiring (`lib/db.ts`).
2) API layer
   - Implement the Hono routes in `server/src/api.ts` under `/api/v1` protected router with filtering and sorting logic.
3) UI layer
   - Build `Events.tsx`, add routes/nav, implement list/search/toggle/create and basic detail.
4) Integration testing
   - Verify end-to-end: create event → appears in list; search works; includePast toggle hides past by default; detail shows fields; update reflects in list.
5) Optional follow-ups
   - Role-based authoring permissions; advanced search (ILIKE across multiple fields with trigram or full-text); link to shifts when available; pagination.

### Request/response shapes (reference)
- List events (GET `/api/v1/events`): returns `Array<{ id, title, promoter?, status, date, startTime, endTime, description?, artists?, updatedAt }>`.
- Create event (POST `/api/v1/events`): accepts body with fields above; returns created event.
- Get event (GET `/api/v1/events/:eventId`): returns the event or 404.
- Update event (PATCH `/api/v1/events/:eventId`): accepts partial body; returns updated event.
- List event shifts (GET `/api/v1/events/:eventId/shifts`): returns `Array<Shift>` (empty until shifts exist in new schema).

### Notes & constraints
- Time-window filtering mirrors v1 to ensure current/future events are shown by default; `includePast=true` surfaces past ones.
- Keep types simple (strings for date/time) for parity and to avoid premature refactors; we can migrate to timestamptz later if needed.
- No new env vars are required beyond existing DB and auth setup.


