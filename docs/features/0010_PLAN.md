## 0010 Plan — Scheduling polish and fixes (per 0009 Review)

Brief
- Address specific gaps and correctness issues identified in `0009_REVIEW.md` for Scheduling (Shifts + Schedules). No data-model changes; focus on API correctness, UI feature completion, and minor refactors to reduce drift.

Scope overview
- Server (Hono):
  - Fix `derivedPublished` in shift create response.
  - Optional cross-department shifts list endpoint to support Department "All".
  - Consolidate date/time validators to `server/src/lib/validators.ts`.
  - Optional: route modularization for maintainability.
- UI (React):
  - Implement assignments panel in shift detail.
  - Add schedule selector and event link display in shift detail.
  - Inline New Shift creation and display server overlap warnings.
  - Quick schedule create and publish/unpublish from filter bar.
  - Make Department "All" functional (or remove it if server endpoint not chosen).

Files to modify / create (exact paths)
- Server
  - Update: `server/src/api.ts`
    - Fix shift create response to compute `derivedPublished` using schedule join.
    - Add `GET /api/v1/shifts` (all-departments) list endpoint (optional, see below).
    - Replace local `isValidDateStr`/`isValidTimeStr` with imports from `server/src/lib/validators.ts`.
  - Update: `server/src/lib/validators.ts`
    - Export `isValidDateStr(s?: unknown): boolean` and `isValidTimeStr(s?: unknown): boolean` (regex based) for reuse.
  - Optional (refactor): add route modules and mount from `api.ts`
    - Add: `server/src/routes/schedules.ts`, `server/src/routes/shifts.ts`, `server/src/routes/assignments.ts` (move existing handlers verbatim, keep signatures; no behavior change).
- UI
  - Update: `ui/src/lib/serverComm.ts`
    - Ensure types: `ShiftRecord` includes `derivedPublished?: boolean` on list responses; create returns `{ shift, warnings?: string[]; derivedPublished?: boolean }` or just `shift` + `warnings` if we choose not to return `derivedPublished`.
    - Add `listAllShifts(params?)` client for `GET /api/v1/shifts` if implementing All-departments endpoint; else, adjust UI to remove All.
    - Add schedule publish/unpublish helpers already present to the exported `api` surface if not yet linked.
  - Update: `ui/src/pages/Scheduling.tsx`
    - List Filter Bar: keep Department, Schedule, Dates, Text, Published toggle.
      - If Department is "All" and server endpoint is implemented: call `listAllShifts` with filters; otherwise, remove the "All" option or default to first department.
      - Add quick schedule create (inline form: name, startDate, endDate) that calls `api.createSchedule`, then refresh schedules and keep selection.
      - Add publish/unpublish control next to the Schedule selector (toggles via `api.publishSchedule` / `api.unpublishSchedule`).
    - List body: add "New Shift" inline creation row (date, startTime, endTime, title?, schedule?), posting to `api.createShift`. On response:
      - If `warnings` present, surface prominently (inline alert/toast) without blocking creation.
    - Detail pane (`ShiftDetail`):
      - Fields: title, date, startTime, endTime, notes.
      - Add Schedule selector (populated from schedules list). When selected and `shift.date` is outside `[schedule.startDate, schedule.endDate]`, show a non-blocking UX warning.
      - Show derived publication badge in detail (compute from selected schedule on the client; no server change required for `PATCH` response).
      - Event link display: if `eventId` present, show linked event title/ID (read-only; no selection control in this plan).
      - Assignments panel: list assignments for the shift; allow create/update/delete and assign/unassign using `api.listAssignments`, `api.createAssignment`, `api.updateAssignment`, `api.deleteAssignment`; use existing eligibility API to populate assignees.

Details and algorithms
- Fix `derivedPublished` on shift create (server):
  - Current: response uses `Boolean(created.scheduleId)` which is incorrect.
  - Change: after insert, perform a join to `schedules` by `scheduleId` and compute `derivedPublished = !!(created.scheduleId && schedule.isPublished)`. Return either:
    - Option A (preferred): `{ ...created, derivedPublished }` (keep current shape stability for list rendering), plus optional `warnings` array.
    - Option B: drop `derivedPublished` from create response and rely on subsequent list fetch; if choosing B, update UI to refetch list after creation.
- Cross-department shifts list (server):
  - Add `GET /api/v1/shifts` that mirrors `GET /api/v1/departments/:departmentId/shifts` but without a required department filter.
  - Query params: `departmentId?` (string or comma-separated values), `q?`, `scheduleId?`, `from?`, `to?`, `published?` (derived via schedules join).
  - Implementation: build conditions dynamically; left join to schedules; compute `derivedPublished` as in dept-scoped handler; order by `asc(date), asc(startTime)`.
  - UI: when Department filter is "All", call this endpoint with the same filters.
- Validators consolidation:
  - Move the utility regexes to `server/src/lib/validators.ts` and import in `api.ts` for both create/update handlers.
- Overlap warnings (already on server):
  - UI behavior: when `warnings` are present in create response, render non-blocking inline alert in the list and/or toast; do not prevent creation.
- Schedule date containment warning (UX-only):
  - When user sets/changes `scheduleId` in detail, if `shift.date` is outside the chosen schedule `[startDate, endDate]`, show a non-blocking warning message near the selector.

Concrete edits (by file and area)
- `server/src/api.ts`
  - In `departmentsRoutes.post('/:departmentId/shifts', ...)`: after insert, fetch `schedule.isPublished` via left join and include correct `derivedPublished` in response. Keep returning any computed `warnings`.
  - Add `api.get('/shifts', ...)` (optional) with the same selection shape as the department-scoped list, including `derivedPublished`.
  - Remove local `isValidDateStr` and `isValidTimeStr`; import from `./lib/validators`.
- `server/src/lib/validators.ts`
  - Add and export `isValidDateStr` and `isValidTimeStr` used by scheduling routes.
- `ui/src/lib/serverComm.ts`
  - Ensure `ShiftRecord` has `derivedPublished?: boolean` for list responses.
  - If keeping `derivedPublished` on create, type the create response accordingly; otherwise, refetch list after create.
  - Add `listAllShifts(params)` when server endpoint is implemented; wire into exported `api` surface.
- `ui/src/pages/Scheduling.tsx`
  - In list filter bar: quick schedule create; publish/unpublish control beside the schedule selector.
  - For Department "All": call `listAllShifts` if available; otherwise remove the All option (fallback path).
  - Add inline New Shift row. Display server `warnings` upon creation.
  - In `ShiftDetail`: add Schedule selector, derived publication badge (computed client-side from selected schedule), event link display, and full Assignments panel wired to API.

Phasing
- Phase A — Server correctness and utilities
  - Fix shift create `derivedPublished`.
  - Consolidate validators.
  - Implement optional cross-department `GET /api/v1/shifts` and wire auth.
- Phase B — UI completion
  - Implement schedule selector, assignments panel, inline New Shift, warnings surfacing, and schedule quick actions.
  - Make Department "All" work with the new endpoint or remove it.
- Phase C — Optional refactor
  - Split scheduling routes into modules to reduce `api.ts` size; no behavior changes.

Notes
- No database schema or migration changes required for this plan.
- Auth remains via existing Firebase Bearer token middleware.
- If opting not to add the all-departments endpoint, remove the Department "All" option and default to first department to avoid empty lists.


