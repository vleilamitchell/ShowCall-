## Feature Plan: Departments (List–Detail using shared framework)

### Context
“Pull 'Departments' over from showcall_v1 into our new app. Make sure to reuse the list/detail layout we use on 'Events'.” The legacy `showcall_v1` defines a `Department` entity with fields `id`, `name`, and optional `description`, plus relationships to positions/employees/schedules. For this iteration, scope Departments to CRUD of the core entity and list/detail UX parity with Events.

---

### Scope and touch points
- UI (React + Tailwind + ShadCN)
  - New page: `ui/src/pages/Departments.tsx` using shared list–detail primitives from `ui/src/features/listDetail`
  - Route: add `/departments` and `/departments/:departmentId` to `ui/src/App.tsx`
  - Reuse `ListDetailLayout`, `List`, `FilterBar`, `CreateInline`, `useListDetail`, `useDebouncedPatch`
- API client
  - Extend `ui/src/lib/serverComm.ts` with `DepartmentRecord` type and helpers: `listDepartments`, `getDepartment`, `createDepartment`, `updateDepartment`
- Server/API (Hono)
  - Add protected routes under `/api/v1/departments` for list/create/get/patch
  - Filtering: `q` (ilike on `name` and `description`), optional `includeEmpty` not needed; stable id is string
- Data layer (Drizzle)
  - Add `server/src/schema/departments.ts` and wire export in `server/src/schema/index.ts`
  - Migration: `server/drizzle/0002_departments.sql` creating `public.departments (id text primary key, name text not null, description text null, updated_at timestamptz default now())`

---

### Detailed design

#### 1) Database schema (Drizzle + SQL)
- New table `public.departments`
  - Columns:
    - `id` text primary key (UUID-like string)
    - `name` text not null
    - `description` text null
    - `updated_at` timestamptz default now()
- File: `server/src/schema/departments.ts`
  - Define Drizzle table with the default/public schema
  - Export as `departments`
- Migration file `server/drizzle/0002_departments.sql`
  - `CREATE TABLE IF NOT EXISTS public.departments ...` with indexes:
    - GIN trigram index on `name` optional, skip initially; basic search can use `ilike`

#### 2) API (Hono) routes
- Mount under `/api/v1/departments` with `authMiddleware`
- Endpoints:
  - `GET /api/v1/departments` → list with optional `q`
    - Query handling: build `where` with `ilike(name, %q%) OR ilike(description, %q%)` if `q` present
    - Order by `name ASC`
  - `POST /api/v1/departments` → create
    - Validate: `name` required (trimmed), `description` optional normalized to null when blank
    - Id generation: prefer `globalThis.crypto.randomUUID()`, fallback to `node:crypto`. Avoid `require()`
  - `GET /api/v1/departments/:departmentId` → fetch single
  - `PATCH /api/v1/departments/:departmentId` → partial update of `name` and `description`; set `updated_at = now()`

#### 3) API client (`ui/src/lib/serverComm.ts`)
- Add type:
  - `export type DepartmentRecord = { id: string; name: string; description?: string | null; updatedAt?: string }`
- Add helpers mirroring Events:
  - `listDepartments({ q }?)` → `GET /api/v1/departments?q=...`
  - `getDepartment(id)` → `GET /api/v1/departments/:id`
  - `createDepartment(payload: { name: string; description?: string | null })`
  - `updateDepartment(id, patch: Partial<DepartmentRecord>)`

#### 4) UI page (`ui/src/pages/Departments.tsx`)
- Implement via shared primitives:
  - `eventsAdapter` equivalent: `departmentsAdapter: ResourceAdapter<DepartmentRecord, {}, { q?: string }>`
    - `list`: `listDepartments({ q })`
    - `get`: `getDepartment(id)`
    - `create`: `createDepartment(partial)`
    - `update`: `updateDepartment(id, patch)`
    - `searchableFields`: `['name', 'description']`
  - Left list: search bar in `FilterBar`; render rows showing `name` and faded `description`
  - Right detail: editable `name` (debounced PATCH), read-only `id`, editable `description` (debounced)
  - Support inline create via `CreateInline` with `name` and optional `description`
  - Keep route-driven selection using `useListDetail` (`/departments/:departmentId`)

#### 5) Routing (`ui/src/App.tsx`)
- Add routes for `/departments` and `/departments/:departmentId`
- Sidebar: ensure a nav link exists or will be added separately; not required for this plan

---

### Algorithms (step-by-step)
1) List querying with search
- On `q` changes, refetch list
- `where` clause matches `name` and `description` via `ilike(%q%)`

2) Selection and routing
- On mount/refetch: if `:departmentId` exists and is in the list, select it; else select the first item
- On click: navigate to `/departments/:id`
- If selected id no longer exists after a mutation, navigate back to `/departments`

3) Debounced field updates
- For `name` and `description` inputs, use `useDebouncedPatch`
- Optimistically update local item; ignore stale responses; flush on blur

---

### File list
- New: `server/src/schema/departments.ts`
- New: `server/drizzle/0002_departments.sql`
- Edited: `server/src/schema/index.ts` (export `departments`)
- Edited: `server/src/api.ts` (mount departments router)
- Edited: `ui/src/lib/serverComm.ts` (Department types and helpers)
- New: `ui/src/pages/Departments.tsx`
- Edited: `ui/src/App.tsx` (add routes)

---

### Notes and constraints
- Keep parity with Events list–detail UX and styling
- No new dependencies; rely on existing stack
- Backend aligns with public schema as with `events`
- Access control: keep endpoints under `authMiddleware` like Events

---

### Acceptance criteria
- Navigating to `/departments` shows a searchable list; selecting a row updates URL `/departments/:id`
- Creating a department via inline form adds it to the list and selects it
- Editing `name` and `description` uses debounced updates with final flush on blur
- API supports list/get/create/update with stable shapes; search filters by name/description
