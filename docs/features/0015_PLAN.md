### 0015 — Technical Plan: Fixes from 0013 Review (Inventory Core and Ledger)

Brief context:
- Address issues and gaps identified in `@0013_REVIEW.md` across projections, availability windowing, attribute validation, unit conversion, policy enforcement, valuation updates, API completeness, and minor API filters.
- No schema renames; extend existing migrations/services. Avoid breaking current API routes.

---

### Scope of changes

- Projections: make `on_hand` refresh safe with CONCURRENTLY, preserve MV usage.
- Availability: implement window-aware availability in services (not a global view).
- Validation: add JSON Schema validation (`ajv`) for item `attributes` on create/patch.
- Units: convert user-provided `qty` + `unit` to `qtyBase` via `unit_conversion`.
- Policies: enforce basic policies in posting (allowed `event_type`, reservation requirements, etc.).
- Valuation: update `valuation_avg` on receipts; compute COGS for negative movements.
- API: add `GET /inventory/transactions`; add item summary endpoint; add `department_id` filter to locations; optionally reconcile route comment.
- UI: only minor client helper additions in `serverComm` to use new endpoints.

---

### Phase 1 — Data layer updates (SQL)

- File: `server/drizzle/0010_inventory_projections.sql`
  - Add a UNIQUE index on the materialized view to allow `REFRESH MATERIALIZED VIEW CONCURRENTLY`:
    - `CREATE UNIQUE INDEX IF NOT EXISTS ux_on_hand_identity ON on_hand (item_id, location_id, lot_id);`
  - Keep the existing non-unique index `idx_on_hand_item_loc` for read patterns.
  - Leave the `availability` view in place for now, but do not depend on it for windowed availability (handled in services below).

- File: `server/src/services/inventory/projections.ts`
  - Keep `refreshOnHandMaterializedView()` using `CONCURRENTLY` (will succeed once the UNIQUE index exists).

---

### Phase 2A — Algorithms and services

1) JSON Schema validation for item `attributes`
   - Files:
     - `server/src/services/inventory/items.ts`
     - New: `server/src/services/inventory/validation.ts` (helper)
   - Dependencies: add `ajv` (and optionally `ajv-formats`). Use `pnpm add -w ajv ajv-formats`.
   - Steps:
     - Read the item’s `schemaId`, fetch `attribute_schema.json_schema` for that `schema_id`.
     - Compile once and cache per `schema_id` in-memory map.
     - On `createInventoryItem` and `patchInventoryItem`, validate `attributes`. On failure, return 400 from route (surface message and first error path).

2) Unit conversion to base units
   - Files:
     - `server/src/services/inventory/postTransaction.ts`
     - New: `server/src/services/inventory/units.ts` (helper)
   - Request change (route-level): allow posting body `{ qty, unit }` OR `{ qtyBase }`. If `{ qty, unit }` present, convert to `qtyBase` before insert; maintain backward compatibility.
   - Algorithm (`convertToBaseUnits(item.baseUnit, qty, unit)`):
     - If `unit === baseUnit`, return `qty`.
     - Else query `unit_conversion` for direct row `(from_unit=unit, to_unit=baseUnit)`; if found, `qtyBase = qty * factor`.
     - Else query inverse `(from_unit=baseUnit, to_unit=unit)`; if found, `qtyBase = qty / factor`.
     - Else reject with clear error: no conversion path.

3) Policy enforcement on posting
   - Files:
     - `server/src/services/inventory/postTransaction.ts`
     - New: `server/src/services/inventory/policies.ts`
   - Minimum rules:
     - Allowed events: verify `input.eventType` is valid (already via `isValidEventType`), and optionally restrict by `item.itemType` using rows in `policy` keyed like `allowed_events`.
     - Reservation requirement: for `MOVE_OUT`/`TRANSFER_OUT`, if a department policy `require_reservation=true`, then require `input.sourceDoc.eventId` or a matching active reservation before allowing.
     - Par/threshold checks (warning-level for now): if policy key `min_on_hand`, compute on-hand and reject negative availability when policy says hard-enforce.
   - Implementation notes: load policies by `(department_id, item_type)` where `department_id` is taken from the `location.department_id` of the posting.

4) Valuation (rolling average and COGS)
   - Files:
     - `server/src/services/inventory/postTransaction.ts`
   - Data reference: `server/drizzle/0010_inventory_projections.sql` defines `valuation_avg(item_id, avg_cost, qty_base)`.
   - Algorithm:
     - On positive movements that represent adding stock (`RECEIPT`, `MOVE_IN`, `TRANSFER_IN`, positive `COUNT_ADJUST`):
       - Let prior `(avgCost=A, qtyBase=Q)`; incoming `(cost=c, qty=q)` where `cost` is `input.costPerBase`.
       - New average: `A' = (A*Q + c*q) / (Q + q)` (guard `Q+q > 0`). New qty: `Q' = Q + q`.
       - Upsert `valuation_avg` with `(A', Q')`.
     - On negative movements that reduce stock (`MOVE_OUT`, `TRANSFER_OUT`, `CONSUMPTION`, `WASTE`, negative `COUNT_ADJUST`):
       - Use current average `A` as COGS. Set `costPerBase` on the inserted ledger rows to `A` if not provided.
       - Update quantity: `Q' = max(0, Q - |q|)`; keep `avgCost` unchanged when `Q' > 0`. If `Q' == 0`, keep `avgCost` as-is or reset to 0 (choose stable non-NaN behavior).
     - Edge cases: if no `valuation_avg` row exists, treat `A=0, Q=0`.

5) Window-aware availability and item summary
   - Files:
     - New: `server/src/services/inventory/projections.ts#getItemSummary(itemId: string, params?: { from?: string; to?: string })`
     - Existing: `server/src/services/inventory/projections.ts` (extend)
   - Behavior:
     - Return `{ onHand: Array<{ locationId, lotId?, qtyBase }>, totals: { onHand, reserved, available } }`.
     - `onHand`: aggregate from `on_hand` MV (sum by `location_id[, lot_id]`).
     - `reserved`: sum of `reservation.qty_base` with `status='HELD'` overlapping window `[from, to]` (if window omitted, use `[now, now]`). Overlap predicate: `NOT (r.end_ts < from OR r.start_ts > to)`.
     - `available = onHand − reserved`.

---

### Phase 2B — API additions/changes

- File: `server/src/api.ts`
  - Add `GET /api/v1/inventory/transactions`:
    - Query params: `itemId?`, `locationId?`, `eventType?` (comma list), `from?`, `to?`, `limit?=100`, `order?=desc`.
    - Delegate to new service (below).
  - Add `GET /api/v1/inventory/items/:itemId/summary`:
    - Query params: `from?`, `to?`. Calls `getItemSummary`.
  - Update `GET /api/v1/inventory/locations` to accept optional `department_id` filter.
  - Optionally update/comment to ensure route mounting comments reflect current structure.

- File: `server/src/services/inventory/transactions.ts` (new)
  - `listTransactions(params)`:
    - Build `WHERE` from optional filters; handle `eventType` as single or list.
    - Order by `ts` per `order` and limit by `limit`.

- File: `server/src/services/inventory/projections.ts` (extend)
  - Implement `getItemSummary` as described in Phase 2A.5.

---

### Phase 3 — Client helpers (UI data layer only)

- File: `ui/src/lib/serverComm.ts`
  - Add `listInventoryTransactions(params)` to call the new endpoint.
  - Add `getInventoryItemSummary(itemId, { from?, to? })`.
  - Update `listInventoryLocations(params?: { departmentId?: string })` to pass `department_id` when provided.

---

### File and Change Map

- SQL
  - Update `server/drizzle/0010_inventory_projections.sql` (UNIQUE index on `on_hand`).

- Services (server)
  - Update `server/src/services/inventory/items.ts` to validate `attributes`.
  - Update `server/src/services/inventory/postTransaction.ts` to convert units, enforce policies, and update valuation.
  - New `server/src/services/inventory/validation.ts` (ajv integration).
  - New `server/src/services/inventory/units.ts` (unit conversion helper).
  - New `server/src/services/inventory/policies.ts` (policy loading/enforcement helpers).
  - New `server/src/services/inventory/transactions.ts` (listTransactions).
  - Update `server/src/services/inventory/projections.ts` to add `getItemSummary`.

- API (server)
  - Update `server/src/api.ts` to add routes: `GET /inventory/transactions`, `GET /inventory/items/:itemId/summary`, and `department_id` filter on `GET /inventory/locations`.

- Client
  - Update `ui/src/lib/serverComm.ts` to add `listInventoryTransactions`, `getInventoryItemSummary`, and extend locations filter.

---

### Notes and constraints

- Package install: run `pnpm add -w ajv ajv-formats` in repo root (workspace install).
- Keep backward compatibility for `POST /inventory/transactions` request body by supporting existing `qtyBase` while allowing new `{ qty, unit }` pair.
- `on_hand` MV refresh: ensure UNIQUE index exists before any concurrent refresh runs.
- Reservation overlap: use `NOT (end_ts < from OR start_ts > to)`.
- Valuation: guard division by zero; use stable defaults when quantity goes to zero.


